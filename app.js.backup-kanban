const express = require('express');
const OpenAI = require('openai');
const Anthropic = require('@anthropic-ai/sdk').default || require('@anthropic-ai/sdk');
const app = express();
const port = process.env.PORT || 3000;

app.use(express.json());

// --‚îÄ API Clients ------------------------------------------------------------‚îÄ
const ANTHROPIC_KEY = process.env.ANTHROPIC_API_KEY || '';
const OPENAI_KEY = process.env.OPENAI_API_KEY || '';

const anthropic = ANTHROPIC_KEY ? new Anthropic({ apiKey: ANTHROPIC_KEY }) : null;
const openai = OPENAI_KEY ? new OpenAI({ apiKey: OPENAI_KEY }) : null;

// --‚îÄ Model Assignments (Cost-Optimized) --------------------------------------
const MODELS = {
  OPUS:       'claude-opus-4-6',       // Jarvis only -- premium synthesis
  SONNET_45:  'claude-sonnet-4-5-20250929',     // Alpha -- strategic lead
  SONNET:     'claude-sonnet-4-20250514',        // Delta, Eta -- analytical depth
  HAIKU:      'claude-haiku-4-5-20251001',       // Gamma, Zeta -- fast & cheap
  GPT4O:      'gpt-4o',                          // Beta, Epsilon -- diversity of thought
};

// --‚îÄ Agent Definitions ------------------------------------------------------‚îÄ
const COUNCIL_AGENTS = [
  {
    id: 'alpha', name: 'Alpha', role: 'Strategist',
    color: '#ff4757', icon: '‚ôüÔ∏è',
    provider: 'anthropic', model: MODELS.SONNET_45, modelLabel: 'Sonnet 4.5',
    system: `You are Alpha, the Strategist on an elite 8-member AI council led by Jarvis. Your expertise is high-level strategy, goal-setting, and long-term planning. Analyze the prompt through a strategic lens. Identify the core objective, propose a clear strategic direction, and outline 2-3 key strategic pillars. Be concise (3-5 sentences). Do NOT repeat the prompt. Speak with authority.`,
  },
  {
    id: 'beta', name: 'Beta', role: 'Researcher',
    color: '#3742fa', icon: 'üî¨',
    provider: 'openai', model: MODELS.GPT4O, modelLabel: 'GPT-4o',
    system: `You are Beta, the Researcher on an elite 8-member AI council led by Jarvis. Your expertise is deep research, data analysis, and evidence-based reasoning. Given the user's prompt and the Strategist's direction, provide 2-3 concrete data points, references, or research-backed insights that strengthen the approach. Be concise (3-5 sentences). Add substance, not fluff.`,
  },
  {
    id: 'gamma', name: 'Gamma', role: 'Executor',
    color: '#2ed573', icon: '‚ö°',
    provider: 'anthropic', model: MODELS.HAIKU, modelLabel: 'Haiku',
    system: `You are Gamma, the Executor on an elite 8-member AI council led by Jarvis. Your expertise is practical implementation, action plans, and getting things done. Given the discussion so far, translate the strategy and research into 3-5 concrete, actionable steps. Be specific with timelines where relevant. Be concise and action-oriented.`,
  },
  {
    id: 'delta', name: 'Delta', role: 'Analyst',
    color: '#ffa502', icon: 'üìä',
    provider: 'anthropic', model: MODELS.SONNET, modelLabel: 'Sonnet',
    system: `You are Delta, the Analyst on an elite 8-member AI council led by Jarvis. Your expertise is risk assessment, metrics, KPIs, and critical analysis. Given the discussion so far, identify 2-3 potential risks or blind spots, suggest measurable KPIs to track success, and provide a brief risk/reward assessment. Be concise and analytical.`,
  },
  {
    id: 'epsilon', name: 'Epsilon', role: 'Creative',
    color: '#a29bfe', icon: 'üé®',
    provider: 'openai', model: MODELS.GPT4O, modelLabel: 'GPT-4o',
    system: `You are Epsilon, the Creative on an elite 8-member AI council led by Jarvis. Your expertise is creative thinking, branding, storytelling, and unconventional ideas. Given the discussion so far, propose 1-2 creative angles, unexpected approaches, or narrative framings that could amplify the impact. Think outside the box. Be concise and inspiring.`,
  },
  {
    id: 'zeta', name: 'Zeta', role: 'Optimizer',
    color: '#fd79a8', icon: 'üîß',
    provider: 'anthropic', model: MODELS.HAIKU, modelLabel: 'Haiku',
    system: `You are Zeta, the Optimizer on an elite 8-member AI council led by Jarvis. Your expertise is efficiency, systems thinking, automation, and resource optimization. Given the discussion so far, identify 1-2 ways to make the plan more efficient, suggest tools or automations, and flag any redundancies. Be concise and pragmatic.`,
  },
  {
    id: 'eta', name: 'Eta', role: 'Synthesizer',
    color: '#00d2d3', icon: 'üß¨',
    provider: 'anthropic', model: MODELS.SONNET, modelLabel: 'Sonnet',
    system: `You are Eta, the Synthesizer on an elite 8-member AI council led by Jarvis. You speak last among the council members before Jarvis makes the final call. Synthesize ALL previous agents' contributions into a coherent briefing. Structure: **Key Themes** (2-3), **Consensus Points**, **Open Questions**. Be concise but thorough. Jarvis will use your synthesis for the final decision.`,
  },
];

const JARVIS = {
  id: 'jarvis', name: 'Jarvis', role: 'Chief of Staff',
  color: '#f9ca24', icon: 'üëë',
  provider: 'anthropic', model: MODELS.OPUS, modelLabel: 'Opus',
  system: `You are Jarvis, Chief of Staff and the decisive leader of an elite 8-member AI council. You have Opus-level intelligence and strategic vision. You've just heard from all 7 council members -- Alpha (Strategist), Beta (Researcher), Gamma (Executor), Delta (Analyst), Epsilon (Creative), Zeta (Optimizer), and Eta (Synthesizer).

Your job: Make the FINAL decision. Don't just summarize -- DECIDE. Take a clear position. Your response structure:

**üéØ Jarvis Decision:**
(1-2 sentences -- your clear verdict and strategic direction)

**üìã Action Plan:**
(3-5 prioritized action items with owners where relevant)

**‚ö†Ô∏è Key Risks & Mitigations:**
(2-3 risks with specific mitigations)

**üí° Strategic Edge:**
(1 sentence -- the creative or competitive advantage)

**üìä Success Metrics:**
(2-3 measurable KPIs)

Be authoritative, decisive, and actionable. This is the council's final word. You are the one who makes the call.`,
};

const ALL_AGENTS = [...COUNCIL_AGENTS, JARVIS];

// --‚îÄ LLM Call Helper --------------------------------------------------------‚îÄ
async function callLLM(agent, messages) {
  if (agent.provider === 'anthropic') {
    if (!anthropic) throw new Error('ANTHROPIC_API_KEY not configured.');
    const systemMsg = messages.find(m => m.role === 'system')?.content || '';
    const userMsgs = messages.filter(m => m.role !== 'system').map(m => ({
      role: m.role,
      content: m.content,
    }));
    const resp = await anthropic.messages.create({
      model: agent.model,
      max_tokens: agent.id === 'jarvis' ? 800 : 500,
      temperature: agent.id === 'jarvis' ? 0.6 : 0.8,
      system: systemMsg,
      messages: userMsgs,
    });
    return resp.content[0]?.text?.trim() || '(no response)';
  } else if (agent.provider === 'openai') {
    if (!openai) throw new Error('OPENAI_API_KEY not configured.');
    const completion = await openai.chat.completions.create({
      model: agent.model,
      messages,
      max_tokens: 500,
      temperature: 0.8,
    });
    return completion.choices[0]?.message?.content?.trim() || '(no response)';
  }
  throw new Error(`Unknown provider: ${agent.provider}`);
}

// --‚îÄ Shared Styles ----------------------------------------------------------‚îÄ
const NAV_STYLE = `
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0a0e27">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mission Ctrl">
  <link rel="apple-touch-icon" sizes="180x180" href="/api/icon/180">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0d1117 100%);
      color: #e0e0e0;
      min-height: 100vh;
    }
    nav {
      background: rgba(10, 14, 39, 0.9);
      backdrop-filter: blur(20px);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      gap: 2rem;
      border-bottom: 1px solid rgba(0, 212, 255, 0.15);
      position: sticky; top: 0; z-index: 100;
    }
    nav .logo {
      font-weight: 800; font-size: 1.1rem;
      background: linear-gradient(135deg, #00d4ff, #7b2ff7);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    nav a {
      color: #5a6a8a; text-decoration: none; font-weight: 500;
      font-size: 0.9rem; transition: all 0.3s; position: relative;
      padding: 0.3rem 0;
    }
    nav a:hover { color: #8b9dc3; }
    nav a.active {
      color: #00d4ff;
    }
    nav a.active::after {
      content: ''; position: absolute; bottom: -4px; left: 0; right: 0;
      height: 2px; background: linear-gradient(90deg, #00d4ff, #7b2ff7);
      border-radius: 1px;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  </style>
`;

const NAV_HTML = `
  <nav>
    <span class="logo">MISSION CTRL</span>
    <a href="/" id="nav-home">Home</a>
    <a href="/council" id="nav-council">Council</a>
    <a href="/growth" id="nav-growth">Growth</a>
    <a href="/pipeline" id="nav-pipeline">Pipeline</a>
    <a href="/content" id="nav-content">Content</a>
    <a href="/memory" id="nav-memory">Memory</a>
  </nav>
  <script>if('serviceWorker' in navigator){navigator.serviceWorker.register('/service-worker.js').catch(function(){})}</script>
`;

// --‚îÄ Home Page --------------------------------------------------------------‚îÄ
app.get('/', (req, res) => {
  res.send(`<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control</title>
    ${NAV_STYLE}
    <style>
      h1 { font-size: 3rem; font-weight: 800;
        background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        margin-bottom: 0.5rem; }
      .subtitle { color: #5a6a8a; font-size: 1.1rem; margin-bottom: 3rem; }
      .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
      .card {
        background: rgba(20, 25, 45, 0.6); border: 1px solid rgba(255,255,255,0.06);
        border-radius: 16px; padding: 2rem; transition: all 0.3s;
        cursor: pointer; text-decoration: none; color: inherit; display: block;
      }
      .card:hover { border-color: rgba(0, 212, 255, 0.3); transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 212, 255, 0.1); }
      .card .icon { font-size: 2rem; margin-bottom: 1rem; }
      .card h2 { color: #c0d0e8; font-size: 1.2rem; margin-bottom: 0.5rem; }
      .card p { color: #5a6a8a; font-size: 0.9rem; line-height: 1.6; }

      /* Market Dashboard */
      .market-section { margin-bottom: 3rem; }
      .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; }
      .section-header h2 { font-size: 1.3rem; font-weight: 700; color: #c0d0e8; display: flex; align-items: center; gap: 0.5rem; }
      .refresh-badge { font-size: 0.72rem; color: #3a4a6a; background: rgba(255,255,255,0.04); padding: 0.3rem 0.8rem; border-radius: 50px; display: flex; align-items: center; gap: 0.4rem; }
      .refresh-badge .livedot { width: 6px; height: 6px; border-radius: 50%; background: #2ed573; animation: liveblink 2s infinite; }
      @keyframes liveblink { 0%,100%{opacity:1} 50%{opacity:0.3} }
      .ticker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 1rem; }
      .ticker-card { background: rgba(20, 25, 50, 0.5); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.06); border-radius: 16px; padding: 1.25rem; transition: all 0.3s; position: relative; overflow: hidden; }
      .ticker-card:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.3); }
      .ticker-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
      .ticker-name { font-weight: 600; font-size: 0.82rem; color: #8b9dc3; }
      .ticker-symbol { font-size: 0.65rem; color: #3a4a6a; background: rgba(255,255,255,0.04); padding: 0.12rem 0.45rem; border-radius: 50px; }
      .ticker-price { font-size: 1.45rem; font-weight: 800; margin-bottom: 0.15rem; }
      .ticker-change { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; }
      .ticker-spark { opacity: 0.7; }
      .ticker-spark svg { display: block; width: 100%; height: 36px; }
      .ticker-loading { grid-column: 1 / -1; text-align: center; padding: 2.5rem; color: #3a4a6a; font-size: 0.9rem; }
      .ticker-error { color: #5a6a8a; font-size: 0.82rem; padding: 0.5rem 0; }

      /* PWA Install Banner */
      .pwa-banner { display: none; background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(123,47,247,0.1)); border: 1px solid rgba(0,212,255,0.2); border-radius: 14px; padding: 1rem 1.5rem; margin-bottom: 2rem; align-items: center; gap: 1rem; }
      .pwa-banner.show { display: flex; }
      .pwa-banner .pwa-text { flex: 1; font-size: 0.88rem; color: #b0c4de; }
      .pwa-banner .pwa-text strong { color: #00d4ff; }
      .pwa-btn { padding: 0.5rem 1.2rem; background: linear-gradient(135deg, #00d4ff, #7b2ff7); border: none; border-radius: 8px; color: white; font-weight: 600; font-size: 0.82rem; cursor: pointer; white-space: nowrap; }
      .pwa-dismiss { background: none; border: none; color: #5a6a8a; cursor: pointer; font-size: 1.1rem; padding: 0.2rem; }
    </style>
  </head><body>
    ${NAV_HTML}
    <div class="container">
      <h1>Mission Control</h1>
      <p class="subtitle">AI-powered operations dashboard</p>

      <!-- PWA Install Banner -->
      <div class="pwa-banner" id="pwaBanner">
        <div class="pwa-text"><strong>üì± Install Mission Control</strong> -- Add to your home screen for instant access</div>
        <button class="pwa-btn" id="pwaInstallBtn" onclick="installPWA()">Install</button>
        <button class="pwa-dismiss" onclick="dismissPWA()">‚úï</button>
      </div>

      <!-- Live Markets -->
      <div class="market-section">
        <div class="section-header">
          <h2>üìä Live Markets</h2>
          <span class="refresh-badge"><span class="livedot"></span> <span id="refreshTimer">Loading...</span></span>
        </div>
        <div class="ticker-grid" id="tickerGrid">
          <div class="ticker-loading">‚è≥ Loading market data...</div>
        </div>
      </div>

      <div class="cards">
        <a href="/council" class="card"><div class="icon">ü§ñ</div><h2>AI Council</h2><p>8 specialized AI agents -- led by Jarvis (Opus) -- collaborate across Anthropic &amp; OpenAI to deliver decisive, multi-perspective analysis.</p></a>
        <a href="/growth" class="card"><div class="icon">üìà</div><h2>Growth</h2><p>Track growth metrics, conversion funnels, and expansion opportunities.</p></a>
        <a href="/pipeline" class="card"><div class="icon">üîÑ</div><h2>Pipeline</h2><p>Manage your project pipeline from ideation to delivery.</p></a>
        <a href="/content" class="card"><div class="icon">‚úçÔ∏è</div><h2>Content</h2><p>Content calendar, ideas engine, and publishing workflow.</p></a>
        <a href="/memory" class="card"><div class="icon">üß†</div><h2>Second Brain</h2><p>Searchable memory vault -- daily journals, long-term memory, and brain documents in one place.</p></a>
      </div>
    </div>
    <script>
      document.getElementById('nav-home').classList.add('active');

      // -- Market Dashboard --
      var refreshSec = 60;
      function loadMarkets() {
        fetch('/api/market').then(function(r){return r.json()}).then(function(data){
          if(data.error){document.getElementById('tickerGrid').innerHTML='<div class="ticker-loading">Market data unavailable</div>';return;}
          renderTickers(data.tickers);
          refreshSec = 60;
        }).catch(function(){
          document.getElementById('tickerGrid').innerHTML='<div class="ticker-loading">Market data unavailable -- will retry</div>';
          refreshSec = 60;
        });
      }
      function renderTickers(tickers) {
        var grid = document.getElementById('tickerGrid');
        grid.innerHTML = tickers.map(function(t){
          if(!t.price && t.price !== 0) return '<div class="ticker-card"><div class="ticker-header"><span class="ticker-name">'+t.icon+' '+t.name+'</span><span class="ticker-symbol">'+t.symbol+'</span></div><div class="ticker-error">Unavailable</div></div>';
          var isUp = t.change >= 0;
          var clr = isUp ? '#2ed573' : '#ff4757';
          var arrow = isUp ? '‚ñ≤' : '‚ñº';
          var priceStr = t.currency === 'AUD' ? 'A$' : '$';
          priceStr += t.price >= 1000 ? t.price.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) : t.price < 1 ? t.price.toFixed(4) : t.price.toFixed(2);
          var sparkSvg = makeSparkline(t.sparkline || [], clr);
          return '<div class="ticker-card"><div class="ticker-header"><span class="ticker-name">'+t.icon+' '+t.name+'</span><span class="ticker-symbol">'+t.symbol+'</span></div><div class="ticker-price" style="color:'+clr+'">'+priceStr+'</div><div class="ticker-change" style="color:'+clr+'">'+arrow+' '+Math.abs(t.change).toFixed(2)+' ('+Math.abs(t.changePercent).toFixed(2)+'%)</div><div class="ticker-spark">'+sparkSvg+'</div></div>';
        }).join('');
      }
      function makeSparkline(data, color) {
        if(!data||data.length<2)return '';
        var w=160,h=36,mn=Math.min.apply(null,data),mx=Math.max.apply(null,data),rng=mx-mn||1;
        var pts=data.map(function(v,i){return (i/(data.length-1))*w+','+(h-((v-mn)/rng)*h*0.85-h*0.05);}).join(' ');
        var fill=pts+' '+w+','+h+' 0,'+h;
        return '<svg viewBox="0 0 '+w+' '+h+'" preserveAspectRatio="none"><defs><linearGradient id="sg'+color.replace('#','')+'" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="'+color+'" stop-opacity="0.3"/><stop offset="100%" stop-color="'+color+'" stop-opacity="0"/></linearGradient></defs><polygon points="'+fill+'" fill="url(#sg'+color.replace('#','')+')" /><polyline points="'+pts+'" fill="none" stroke="'+color+'" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      }
      loadMarkets();
      setInterval(function(){
        refreshSec--;
        if(refreshSec<=0){loadMarkets();}
        var el=document.getElementById('refreshTimer');
        if(el)el.textContent=refreshSec>0?'Refresh in '+refreshSec+'s':'Refreshing...';
      },1000);

      // -- PWA Install --
      var deferredPrompt = null;
      window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault();
        deferredPrompt = e;
        if(!localStorage.getItem('pwa_dismissed')){document.getElementById('pwaBanner').classList.add('show');}
      });
      function installPWA(){
        if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(function(){deferredPrompt=null;document.getElementById('pwaBanner').classList.remove('show');});}
        else{
          // iOS fallback
          document.getElementById('pwaBanner').querySelector('.pwa-text').innerHTML='<strong>üì± To install:</strong> Tap <strong>Share</strong> ‚Üí <strong>Add to Home Screen</strong>';
          document.getElementById('pwaInstallBtn').style.display='none';
        }
      }
      function dismissPWA(){document.getElementById('pwaBanner').classList.remove('show');localStorage.setItem('pwa_dismissed','1');}
      // Show iOS install hint
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      var isStandalone = window.navigator.standalone === true;
      if(isIOS && !isStandalone && !localStorage.getItem('pwa_dismissed')){
        setTimeout(function(){document.getElementById('pwaBanner').classList.add('show');},2000);
      }
    </script>
  </body></html>`);
});

// --‚îÄ Council Page ------------------------------------------------------------
app.get('/council', (req, res) => {
  const allAgentsJSON = JSON.stringify(ALL_AGENTS.map(a => ({
    id: a.id, name: a.name, role: a.role, color: a.color, icon: a.icon, modelLabel: a.modelLabel
  })));

  res.send(`<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Council -- Mission Control</title>
    ${NAV_STYLE}
    <style>
      /* -- Layout -- */
      .council-layout {
        display: flex; gap: 1.5rem; align-items: flex-start;
      }
      .council-main { flex: 1; min-width: 0; }
      .page-header { margin-bottom: 2rem; }
      .page-header h1 {
        font-size: 2.2rem; font-weight: 800;
        background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      }
      .page-header p { color: #5a6a8a; margin-top: 0.3rem; }

      /* -- Agent Sidebar -- */
      .agent-sidebar {
        width: 260px; flex-shrink: 0;
        position: sticky; top: 80px;
        display: flex; flex-direction: column; gap: 0;
      }
      .sidebar-panel {
        background: rgba(12, 15, 30, 0.7);
        backdrop-filter: blur(24px);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 18px;
        overflow: hidden;
      }
      .sidebar-header {
        padding: 1rem 1.25rem 0.75rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
      }
      .sidebar-header h3 {
        font-size: 0.8rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 1.2px;
        background: linear-gradient(135deg, #00d4ff, #7b2ff7);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      }
      .sidebar-header .sidebar-sub {
        font-size: 0.68rem; color: #3a4a6a; margin-top: 0.2rem;
      }
      .sidebar-agents {
        padding: 0.5rem 0;
      }
      .sidebar-agent {
        display: flex; align-items: center; gap: 0.65rem;
        padding: 0.6rem 1.25rem;
        transition: all 0.4s ease;
        position: relative;
        cursor: default;
      }
      .sidebar-agent:hover {
        background: rgba(255,255,255,0.02);
      }
      .sidebar-agent::before {
        content: '';
        position: absolute; left: 0; top: 15%; bottom: 15%;
        width: 3px; border-radius: 0 3px 3px 0;
        background: var(--agent-color);
        opacity: 0;
        transition: opacity 0.4s;
      }
      .sidebar-agent.active::before { opacity: 1; }
      .sidebar-agent.active {
        background: rgba(255,255,255,0.03);
      }
      .sidebar-agent .sa-icon {
        width: 34px; height: 34px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1rem; flex-shrink: 0;
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.06);
        transition: all 0.4s;
        position: relative;
      }
      .sidebar-agent.active .sa-icon {
        background: color-mix(in srgb, var(--agent-color) 12%, transparent);
        border-color: color-mix(in srgb, var(--agent-color) 30%, transparent);
        box-shadow: 0 0 12px color-mix(in srgb, var(--agent-color) 25%, transparent);
      }
      .sidebar-agent .sa-pulse {
        position: absolute; inset: -3px;
        border-radius: 12px;
        border: 2px solid var(--agent-color);
        opacity: 0;
        animation: none;
      }
      .sidebar-agent.active .sa-pulse {
        animation: sidebarPulse 2s ease-in-out infinite;
      }
      @keyframes sidebarPulse {
        0%, 100% { opacity: 0; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.08); }
      }
      .sidebar-agent .sa-info { flex: 1; min-width: 0; }
      .sidebar-agent .sa-name {
        font-size: 0.82rem; font-weight: 600; color: #c0d0e8;
        transition: color 0.4s;
        display: flex; align-items: center; gap: 0.4rem;
      }
      .sidebar-agent.active .sa-name { color: var(--agent-color); }
      .sidebar-agent .sa-role {
        font-size: 0.68rem; color: #4a5a7a;
        margin-top: 0.1rem;
      }
      .sidebar-agent .sa-model {
        font-size: 0.58rem; padding: 0.12rem 0.45rem;
        border-radius: 50px;
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.06);
        color: #4a5a7a;
        flex-shrink: 0;
        transition: all 0.4s;
      }
      .sidebar-agent.active .sa-model {
        background: color-mix(in srgb, var(--agent-color) 8%, transparent);
        border-color: color-mix(in srgb, var(--agent-color) 20%, transparent);
        color: var(--agent-color);
      }
      .sidebar-agent .sa-status {
        width: 7px; height: 7px; border-radius: 50%;
        background: #2a3040; flex-shrink: 0;
        transition: all 0.4s;
      }
      .sidebar-agent.active .sa-status {
        background: var(--agent-color);
        box-shadow: 0 0 8px var(--agent-color);
        animation: statusPulse 1.5s ease-in-out infinite;
      }
      .sidebar-agent.done .sa-status {
        background: var(--agent-color);
        opacity: 0.7;
      }
      @keyframes statusPulse {
        0%, 100% { box-shadow: 0 0 4px var(--agent-color); }
        50% { box-shadow: 0 0 12px var(--agent-color); }
      }
      .sidebar-divider {
        padding: 0.5rem 1.25rem 0.3rem;
        display: flex; align-items: center; gap: 0.5rem;
      }
      .sidebar-divider::before, .sidebar-divider::after {
        content: ''; flex: 1; height: 1px;
        background: linear-gradient(90deg, transparent, rgba(249, 202, 36, 0.2), transparent);
      }
      .sidebar-divider span {
        font-size: 0.6rem; color: #f9ca2480;
        text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600;
      }
      .sidebar-agent.jarvis-agent .sa-icon {
        background: rgba(249, 202, 36, 0.08);
        border-color: rgba(249, 202, 36, 0.2);
      }
      .sidebar-agent.jarvis-agent .sa-name { color: #f9ca24; }
      .sidebar-agent.jarvis-agent.active .sa-icon {
        box-shadow: 0 0 16px rgba(249, 202, 36, 0.3);
      }

      /* -- Responsive -- */
      @media (max-width: 960px) {
        .council-layout { flex-direction: column-reverse; }
        .agent-sidebar {
          width: 100%; position: static;
          flex-direction: row; overflow-x: auto;
        }
        .sidebar-panel { border-radius: 14px; min-width: 100%; }
        .sidebar-agents {
          display: flex; flex-wrap: wrap; gap: 0;
        }
        .sidebar-agent { padding: 0.5rem 0.8rem; }
        .sidebar-divider { display: none; }
      }

      /* -- Old Roster (removed -- replaced by sidebar) -- */

      /* -- Inline chip roster (kept for backward compat) -- */
      .agent-chip {
        display: flex; align-items: center; gap: 0.5rem;
        padding: 0.5rem 1rem; border-radius: 50px;
        background: rgba(30, 35, 55, 0.8);
        border: 1px solid rgba(255,255,255,0.08);
        font-size: 0.82rem; transition: all 0.4s;
        position: relative;
      }
      .agent-chip .dot {
        width: 8px; height: 8px; border-radius: 50%;
        flex-shrink: 0; transition: all 0.4s;
        opacity: 0.4;
      }
      .agent-chip.active { border-color: var(--agent-color); }
      .agent-chip.active .dot {
        opacity: 1;
        box-shadow: 0 0 8px var(--agent-color);
        animation: pulse 1.5s ease-in-out infinite;
      }
      .agent-chip.done .dot { opacity: 1; }
      .agent-chip .role { color: #5a6a8a; font-size: 0.75rem; }
      .agent-chip .name { color: #c0d0e8; font-weight: 600; }
      .agent-chip .model-tag {
        font-size: 0.6rem; color: #4a5a7a; background: rgba(255,255,255,0.04);
        padding: 0.1rem 0.4rem; border-radius: 50px;
      }
      @keyframes pulse {
        0%, 100% { box-shadow: 0 0 4px var(--agent-color); }
        50% { box-shadow: 0 0 14px var(--agent-color); }
      }

      /* -- Input Area -- */
      .input-area {
        display: flex; gap: 0.75rem; margin-bottom: 2rem;
      }
      .input-area input {
        flex: 1; padding: 0.9rem 1.2rem;
        background: rgba(15, 18, 35, 0.8);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px; color: #e0e0e0;
        font-size: 1rem; font-family: inherit;
        transition: border-color 0.3s;
        outline: none;
      }
      .input-area input:focus { border-color: rgba(0, 212, 255, 0.5); }
      .input-area input::placeholder { color: #3a4a6a; }
      .btn-primary {
        padding: 0.9rem 2rem;
        background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%);
        border: none; border-radius: 12px;
        color: white; font-weight: 700; font-size: 0.95rem;
        cursor: pointer; transition: all 0.3s;
        font-family: inherit; white-space: nowrap;
      }
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
      }
      .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

      /* -- Chat Feed -- */
      .feed {
        display: flex; flex-direction: column; gap: 1rem;
        margin-bottom: 2rem;
      }
      .msg {
        padding: 1.25rem 1.5rem;
        background: rgba(15, 20, 40, 0.7);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 14px;
        border-left: 3px solid var(--agent-color, #333);
        animation: fadeSlide 0.4s ease-out;
      }
      .msg .msg-header {
        display: flex; align-items: center; gap: 0.6rem;
        margin-bottom: 0.6rem;
      }
      .msg .msg-icon {
        width: 28px; height: 28px; border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.9rem; flex-shrink: 0;
        background: rgba(255,255,255,0.05);
      }
      .msg .msg-name {
        font-weight: 700; color: var(--agent-color, #c0d0e8);
        font-size: 0.9rem;
      }
      .msg .msg-role {
        font-size: 0.75rem; color: #5a6a8a;
        background: rgba(255,255,255,0.04);
        padding: 0.15rem 0.5rem; border-radius: 50px;
      }
      .msg .msg-model {
        font-size: 0.65rem; color: #4a5a7a;
        margin-left: auto;
      }
      .msg .msg-body {
        color: #b0c4de; font-size: 0.92rem; line-height: 1.7;
        white-space: pre-wrap;
      }
      .msg .msg-body strong { color: #e0e8f0; }
      @keyframes fadeSlide {
        from { opacity: 0; transform: translateY(12px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* -- User message -- */
      .msg.user-msg {
        background: rgba(0, 212, 255, 0.06);
        border-left-color: #00d4ff;
      }

      /* -- Jarvis Decision Card -- */
      .jarvis-card {
        background: linear-gradient(135deg, rgba(249, 202, 36, 0.06), rgba(249, 150, 36, 0.04));
        border: 1px solid rgba(249, 202, 36, 0.25);
        border-radius: 16px; padding: 2rem;
        animation: fadeSlide 0.5s ease-out;
        position: relative;
        overflow: hidden;
      }
      .jarvis-card::before {
        content: '';
        position: absolute; top: 0; left: 0; right: 0; height: 2px;
        background: linear-gradient(90deg, #f9ca24, #f39c12, #f9ca24);
      }
      .jarvis-card .jarvis-header {
        display: flex; align-items: center; gap: 0.75rem;
        margin-bottom: 1.25rem;
      }
      .jarvis-card .jarvis-header .crown {
        font-size: 1.5rem;
      }
      .jarvis-card .jarvis-header h3 {
        font-size: 1.1rem; font-weight: 800;
        background: linear-gradient(135deg, #f9ca24, #f39c12);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      }
      .jarvis-card .jarvis-header .jarvis-badge {
        font-size: 0.65rem; color: #f9ca24;
        background: rgba(249, 202, 36, 0.1);
        border: 1px solid rgba(249, 202, 36, 0.2);
        padding: 0.15rem 0.5rem; border-radius: 50px;
        margin-left: auto;
      }
      .jarvis-card .jarvis-body {
        color: #d4c5a0; font-size: 0.95rem; line-height: 1.8;
        white-space: pre-wrap;
      }
      .jarvis-card .jarvis-body strong { color: #f0e6c0; }

      /* -- Phase Divider -- */
      .phase-divider {
        display: flex; align-items: center; gap: 1rem;
        margin: 1.5rem 0;
        animation: fadeSlide 0.4s ease-out;
      }
      .phase-divider::before, .phase-divider::after {
        content: ''; flex: 1; height: 1px;
        background: linear-gradient(90deg, transparent, rgba(249, 202, 36, 0.3), transparent);
      }
      .phase-divider span {
        font-size: 0.75rem; color: #f9ca24; font-weight: 700;
        text-transform: uppercase; letter-spacing: 1px;
        white-space: nowrap;
      }

      /* -- Typing Indicator -- */
      .typing-indicator {
        display: flex; align-items: center; gap: 0.6rem;
        padding: 1rem 1.5rem;
        background: rgba(15, 20, 40, 0.5);
        border: 1px solid rgba(255,255,255,0.04);
        border-radius: 14px;
        border-left: 3px solid var(--agent-color, #333);
        animation: fadeSlide 0.3s ease-out;
      }
      .typing-indicator.jarvis-typing {
        background: rgba(249, 202, 36, 0.04);
        border: 1px solid rgba(249, 202, 36, 0.15);
        border-left: 3px solid #f9ca24;
      }
      .typing-dots { display: flex; gap: 4px; }
      .typing-dots span {
        width: 6px; height: 6px; border-radius: 50%;
        background: var(--agent-color, #5a6a8a);
        animation: typingBounce 1.2s infinite;
      }
      .typing-dots span:nth-child(2) { animation-delay: 0.15s; }
      .typing-dots span:nth-child(3) { animation-delay: 0.3s; }
      @keyframes typingBounce {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-6px); opacity: 1; }
      }
      .typing-label { color: #5a6a8a; font-size: 0.82rem; }

      /* -- Empty State -- */
      .empty-state {
        text-align: center; padding: 4rem 2rem;
        color: #3a4a6a;
      }
      .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
      .empty-state p { font-size: 0.95rem; line-height: 1.6; }
      .empty-state .hint { font-size: 0.82rem; margin-top: 1rem; color: #2a3a5a; }
      .empty-state .flow {
        display: flex; align-items: center; justify-content: center;
        gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap;
      }
      .empty-state .flow-step {
        font-size: 0.72rem; padding: 0.2rem 0.6rem;
        border-radius: 50px; background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.06);
        color: #4a5a7a;
      }
      .empty-state .flow-step.jarvis {
        background: rgba(249, 202, 36, 0.08);
        border-color: rgba(249, 202, 36, 0.2);
        color: #f9ca24;
      }
      .empty-state .flow-arrow { color: #2a3a5a; font-size: 0.7rem; }

      /* -- Error -- */
      .error-msg {
        background: rgba(255, 71, 87, 0.1);
        border: 1px solid rgba(255, 71, 87, 0.3);
        border-radius: 12px; padding: 1rem 1.5rem;
        color: #ff6b7a; font-size: 0.9rem;
        animation: fadeSlide 0.3s ease-out;
      }

      /* -- Session counter -- */
      .session-info {
        display: flex; justify-content: flex-end; margin-bottom: 0.5rem;
      }
      .session-info span {
        font-size: 0.75rem; color: #3a4a6a;
        background: rgba(255,255,255,0.03);
        padding: 0.2rem 0.6rem; border-radius: 50px;
      }
    </style>
  </head><body>
    ${NAV_HTML}
    <div class="container">
      <div class="page-header">
        <h1>ü§ñ AI Council</h1>
        <p>8 agents. Led by Jarvis. Multi-model AI collaboration across Anthropic &amp; OpenAI.</p>
      </div>

      <div class="council-layout">
        <!-- Main Content -->
        <div class="council-main">
          <!-- Input -->
          <div class="input-area">
            <input type="text" id="prompt" placeholder="Enter a challenge, question, or strategy for the council..." autocomplete="off" />
            <button class="btn-primary" id="submitBtn" onclick="submitPrompt()">Convene Council</button>
          </div>

          <!-- Feed -->
          <div id="feed">
            <div class="empty-state">
              <div class="icon">üèõÔ∏è</div>
              <p>The council chamber is ready.<br>8 agents await your prompt -- 7 collaborate, then Jarvis decides.</p>
              <div class="flow">
                <span class="flow-step">‚ôüÔ∏è Alpha</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-step">üî¨ Beta</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-step">‚ö° Gamma</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-step">üìä Delta</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-step">üé® Epsilon</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-step">üîß Zeta</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-step">üß¨ Eta</span>
                <span class="flow-arrow">‚Üí</span>
                <span class="flow-step jarvis">üëë Jarvis</span>
              </div>
              <p class="hint">Cost-optimized: Haiku for speed ¬∑ Sonnet for depth ¬∑ GPT-4o for diversity ¬∑ Opus for decisions</p>
            </div>
          </div>
        </div>

        <!-- Agent Roster Sidebar -->
        <aside class="agent-sidebar">
          <div class="sidebar-panel">
            <div class="sidebar-header">
              <h3>Agent Roster</h3>
              <div class="sidebar-sub">8 agents ¬∑ 4 models ¬∑ 2 providers</div>
            </div>
            <div class="sidebar-agents">
              ${COUNCIL_AGENTS.map(a => `
              <div class="sidebar-agent" id="chip-${a.id}" style="--agent-color: ${a.color}">
                <div class="sa-icon">
                  ${a.icon}
                  <div class="sa-pulse"></div>
                </div>
                <div class="sa-info">
                  <div class="sa-name">${a.name}</div>
                  <div class="sa-role">${a.role}</div>
                </div>
                <span class="sa-model">${a.modelLabel}</span>
                <div class="sa-status"></div>
              </div>
              `).join('')}
              <div class="sidebar-divider"><span>Decision</span></div>
              <div class="sidebar-agent jarvis-agent" id="chip-jarvis" style="--agent-color: #f9ca24">
                <div class="sa-icon">
                  üëë
                  <div class="sa-pulse"></div>
                </div>
                <div class="sa-info">
                  <div class="sa-name">Jarvis</div>
                  <div class="sa-role">Chief of Staff</div>
                </div>
                <span class="sa-model">Opus</span>
                <div class="sa-status"></div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <script>
      const AGENTS = ${allAgentsJSON};
      const COUNCIL = AGENTS.filter(a => a.id !== 'jarvis');
      const JARVIS_AGENT = AGENTS.find(a => a.id === 'jarvis');
      const feed = document.getElementById('feed');
      const promptInput = document.getElementById('prompt');
      const submitBtn = document.getElementById('submitBtn');
      let isRunning = false;
      let sessionCount = 0;

      // Multi-turn conversation state
      let conversationRounds = []; // Array of {prompt, responses:[{name,role,text}]}
      let currentRoundResponses = [];
      let currentRoundPrompt = '';

      function resetChips() {
        AGENTS.forEach(a => {
          const chip = document.getElementById('chip-' + a.id);
          if (chip) chip.classList.remove('active', 'done');
        });
      }

      function activateChip(agentId) {
        const chip = document.getElementById('chip-' + agentId);
        if (chip) chip.classList.add('active');
      }

      function doneChip(agentId) {
        const chip = document.getElementById('chip-' + agentId);
        if (chip) { chip.classList.remove('active'); chip.classList.add('done'); }
      }

      function addUserMessage(text) {
        const div = document.createElement('div');
        div.className = 'msg user-msg';
        div.style = '--agent-color: #00d4ff';
        div.innerHTML =
          '<div class="msg-header">' +
            '<div class="msg-icon">üë§</div>' +
            '<span class="msg-name" style="color: #00d4ff">You</span>' +
          '</div>' +
          '<div class="msg-body">' + escapeHtml(text) + '</div>';
        feed.appendChild(div);
        scrollToBottom();
      }

      function addTypingIndicator(agent) {
        const isJarvis = agent.id === 'jarvis';
        const div = document.createElement('div');
        div.className = 'typing-indicator' + (isJarvis ? ' jarvis-typing' : '');
        div.id = 'typing-' + agent.id;
        div.style = '--agent-color: ' + agent.color;
        div.innerHTML =
          '<div class="typing-dots"><span></span><span></span><span></span></div>' +
          '<span class="typing-label">' + agent.icon + ' ' + agent.name + ' (' + agent.role + ') is ' +
          (isJarvis ? 'making the final decision...' : 'thinking...') + '</span>';
        feed.appendChild(div);
        scrollToBottom();
      }

      function removeTypingIndicator(agentId) {
        const el = document.getElementById('typing-' + agentId);
        if (el) el.remove();
      }

      function addAgentMessage(agent, text) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.style = '--agent-color: ' + agent.color;
        div.innerHTML =
          '<div class="msg-header">' +
            '<div class="msg-icon">' + agent.icon + '</div>' +
            '<span class="msg-name">' + agent.name + '</span>' +
            '<span class="msg-role">' + agent.role + '</span>' +
            '<span class="msg-model">' + agent.modelLabel + '</span>' +
          '</div>' +
          '<div class="msg-body">' + formatMarkdown(text) + '</div>';
        feed.appendChild(div);
        scrollToBottom();
      }

      function addPhaseDivider() {
        const div = document.createElement('div');
        div.className = 'phase-divider';
        div.innerHTML = '<span>üëë Jarvis -- Final Decision</span>';
        feed.appendChild(div);
        scrollToBottom();
      }

      function addJarvisDecision(text) {
        const div = document.createElement('div');
        div.className = 'jarvis-card';
        div.innerHTML =
          '<div class="jarvis-header">' +
            '<span class="crown">üëë</span>' +
            '<h3>Jarvis -- Final Decision</h3>' +
            '<span class="jarvis-badge">Opus ¬∑ Chief of Staff</span>' +
          '</div>' +
          '<div class="jarvis-body">' + formatMarkdown(text) + '</div>' +
          '<div style="margin-top:1.25rem;padding-top:1rem;border-top:1px solid rgba(249,202,36,0.15);display:flex;align-items:center;gap:0.75rem">' +
            '<button onclick="startContinueDiscussion()" style="padding:0.6rem 1.4rem;background:rgba(249,202,36,0.12);border:1px solid rgba(249,202,36,0.3);border-radius:10px;color:#f9ca24;font-weight:600;font-size:0.82rem;cursor:pointer;font-family:inherit;transition:all 0.3s" onmouseover="this.style.background=\'rgba(249,202,36,0.2)\'" onmouseout="this.style.background=\'rgba(249,202,36,0.12)\'">üí¨ Continue Discussion</button>' +
            '<span style="font-size:0.72rem;color:#4a5a6a">Ask a follow-up with full context</span>' +
          '</div>';
        feed.appendChild(div);
        scrollToBottom();
      }

      function startContinueDiscussion() {
        promptInput.placeholder = 'Ask a follow-up question (the council has full context)...';
        submitBtn.textContent = 'Continue Discussion';
        promptInput.focus();
        promptInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      function addError(text) {
        const div = document.createElement('div');
        div.className = 'error-msg';
        div.textContent = text;
        feed.appendChild(div);
        scrollToBottom();
      }

      function scrollToBottom() {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }

      function escapeHtml(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      function formatMarkdown(text) {
        let html = escapeHtml(text);
        html = html.replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>');
        html = html.replace(/^[-‚Ä¢] (.+)$/gm, '&nbsp;&nbsp;‚Ä¢ $1');
        html = html.replace(/^(\\d+)\\. (.+)$/gm, '&nbsp;&nbsp;$1. $2');
        return html;
      }

      async function submitPrompt() {
        if (isRunning) return;
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        isRunning = true;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Council in session...';
        promptInput.value = '';

        // Track current round
        currentRoundResponses = [];
        currentRoundPrompt = prompt;

        if (sessionCount === 0) {
          feed.innerHTML = '';
        } else {
          const sep = document.createElement('hr');
          sep.style.cssText = 'border: none; border-top: 1px solid rgba(255,255,255,0.06); margin: 2rem 0;';
          feed.appendChild(sep);
        }
        sessionCount++;

        const isFollowUp = conversationRounds.length > 0;
        const badge = document.createElement('div');
        badge.className = 'session-info';
        badge.innerHTML = '<span>' + (isFollowUp ? 'Follow-up Round #' + (conversationRounds.length + 1) : 'Session #' + sessionCount) + '</span>';
        feed.appendChild(badge);

        resetChips();
        addUserMessage(prompt);

        try {
          const reqBody = { prompt };
          if (conversationRounds.length > 0) {
            reqBody.history = conversationRounds;
          }

          const res = await fetch('/api/council', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(reqBody),
          });

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });

            const lines = buffer.split('\\n');
            buffer = lines.pop();

            for (const line of lines) {
              if (!line.startsWith('data: ')) continue;
              const data = line.slice(6);
              if (data === '[DONE]') continue;

              try {
                const evt = JSON.parse(data);

                if (evt.type === 'thinking') {
                  const agent = AGENTS.find(a => a.id === evt.agentId);
                  if (agent) {
                    activateChip(agent.id);
                    addTypingIndicator(agent);
                  }
                } else if (evt.type === 'response') {
                  const agent = AGENTS.find(a => a.id === evt.agentId);
                  if (agent) {
                    removeTypingIndicator(agent.id);
                    doneChip(agent.id);
                    addAgentMessage(agent, evt.text);
                    currentRoundResponses.push({ name: agent.name, role: agent.role, text: evt.text });
                  }
                } else if (evt.type === 'phase') {
                  addPhaseDivider();
                } else if (evt.type === 'jarvis') {
                  removeTypingIndicator('jarvis');
                  doneChip('jarvis');
                  addJarvisDecision(evt.text);
                  currentRoundResponses.push({ name: 'Jarvis', role: 'Chief of Staff', text: evt.text });
                  // Save this round to conversation history
                  conversationRounds.push({ prompt: currentRoundPrompt, responses: currentRoundResponses });
                } else if (evt.type === 'error') {
                  addError(evt.text);
                }
              } catch (e) { /* skip malformed */ }
            }
          }
        } catch (err) {
          addError('Connection error: ' + err.message);
        }

        isRunning = false;
        submitBtn.disabled = false;
        submitBtn.textContent = conversationRounds.length > 0 ? 'Continue Discussion' : 'Convene Council';
        if (conversationRounds.length > 0) {
          promptInput.placeholder = 'Ask a follow-up question (the council has full context)...';
        }
      }

      promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          submitPrompt();
        }
      });
    </script>
    <script>document.getElementById('nav-council').classList.add('active');</script>
  </body></html>`);
});

// --‚îÄ Council API (SSE streaming) --------------------------------------------‚îÄ
app.post('/api/council', async (req, res) => {
  const { prompt, history } = req.body;
  if (!prompt || typeof prompt !== 'string' || prompt.trim().length === 0) {
    return res.status(400).json({ error: 'Prompt is required.' });
  }

  // Check that at least one provider is configured
  if (!anthropic && !openai) {
    return res.status(500).json({ error: 'No API keys configured. Set ANTHROPIC_API_KEY and/or OPENAI_API_KEY.' });
  }

  // Set up SSE
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.flushHeaders();

  const send = (data) => {
    res.write(`data: ${JSON.stringify(data)}\n\n`);
  };

  // Build prior conversation context from history
  const hasHistory = Array.isArray(history) && history.length > 0;
  let priorContext = '';
  if (hasHistory) {
    const rounds = history.map((round, i) => {
      let r = `--- Round ${i + 1} ---\nUser: "${round.prompt}"`;
      (round.responses || []).forEach(resp => {
        r += `\n[${resp.name} -- ${resp.role}]: ${resp.text}`;
      });
      return r;
    }).join('\n\n');
    priorContext = `=== Previous Discussion ===\n${rounds}\n\n=== Current Follow-up ===\n`;
  }

  const conversationHistory = [];

  try {
    // -- Phase 1: Council Agents (Alpha ‚Üí Eta) --
    for (const agent of COUNCIL_AGENTS) {
      send({ type: 'thinking', agentId: agent.id });

      const systemContent = hasHistory
        ? agent.system + `\n\nIMPORTANT: This is a follow-up round in an ongoing council discussion. The user has a new question based on the previous rounds. Build on prior insights -- don't repeat what was already said. Address the new question directly.`
        : agent.system;

      let userContent;
      if (hasHistory) {
        userContent = priorContext + `User follow-up: "${prompt.trim()}"`;
        if (conversationHistory.length > 0) {
          userContent += `\n\nCouncil discussion this round so far:\n${conversationHistory.map(h => `[${h.name} -- ${h.role}]: ${h.text}`).join('\n\n')}`;
        }
      } else {
        userContent = conversationHistory.length === 0
          ? `User prompt: "${prompt.trim()}"`
          : `User prompt: "${prompt.trim()}"\n\nCouncil discussion so far:\n${conversationHistory.map(h => `[${h.name} -- ${h.role}]: ${h.text}`).join('\n\n')}`;
      }

      const messages = [
        { role: 'system', content: systemContent },
        { role: 'user', content: userContent },
      ];

      try {
        const text = await callLLM(agent, messages);
        conversationHistory.push({ name: agent.name, role: agent.role, text });
        send({ type: 'response', agentId: agent.id, text });
      } catch (err) {
        const fallbackText = `(${agent.name} unavailable: ${err.message})`;
        conversationHistory.push({ name: agent.name, role: agent.role, text: fallbackText });
        send({ type: 'response', agentId: agent.id, text: fallbackText });
      }
    }

    // -- Phase 2: Jarvis Final Decision (Opus) --
    send({ type: 'phase' });
    send({ type: 'thinking', agentId: 'jarvis' });

    const jarvisSystem = hasHistory
      ? JARVIS.system + `\n\nThis is a follow-up round. The user asked a new question after your previous decision. Reference your prior decision where relevant and address the new question decisively.`
      : JARVIS.system;

    let jarvisUserContent;
    if (hasHistory) {
      jarvisUserContent = priorContext + `User follow-up: "${prompt.trim()}"\n\nFull council transcript this round:\n${conversationHistory.map(h => `[${h.name} -- ${h.role}]: ${h.text}`).join('\n\n')}\n\nYou are Jarvis. Address this follow-up decisively.`;
    } else {
      jarvisUserContent = `Original prompt: "${prompt.trim()}"\n\nFull council transcript:\n${conversationHistory.map(h => `[${h.name} -- ${h.role}]: ${h.text}`).join('\n\n')}\n\nYou are Jarvis. You've heard everyone. Now make the call.`;
    }

    const jarvisMessages = [
      { role: 'system', content: jarvisSystem },
      { role: 'user', content: jarvisUserContent },
    ];

    const jarvisText = await callLLM(JARVIS, jarvisMessages);
    send({ type: 'jarvis', text: jarvisText });

  } catch (err) {
    console.error('Council API error:', err.message);
    send({ type: 'error', text: 'AI error: ' + (err.message || 'Unknown error') });
  }

  res.write('data: [DONE]\n\n');
  res.end();
});

// --‚îÄ YouTube API Configuration ----------------------------------------------‚îÄ
const YT_API_KEY = process.env.YOUTUBE_API_KEY || 'AIzaSyBNe1tR9xOaVvZ8qH3X2wY1pQ4rS6tU7vW';

// --‚îÄ YouTube API Proxy Endpoints --------------------------------------------‚îÄ
app.get('/api/youtube/search', async (req, res) => {
  try {
    const q = req.query.q;
    if (!q) return res.status(400).json({ error: 'Query required' });
    const url = 'https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&maxResults=5&q=' + encodeURIComponent(q) + '&key=' + YT_API_KEY;
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.error) return res.status(400).json({ error: data.error.message });
    const channels = (data.items || []).map(i => ({
      id: i.snippet.channelId,
      title: i.snippet.title,
      description: i.snippet.description,
      thumbnail: i.snippet.thumbnails?.default?.url
    }));
    res.json({ channels });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.get('/api/youtube/dashboard', async (req, res) => {
  try {
    const channelId = req.query.channelId;
    if (!channelId) return res.status(400).json({ error: 'channelId required' });

    // Fetch channel stats
    const chUrl = 'https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings&id=' + encodeURIComponent(channelId) + '&key=' + YT_API_KEY;
    const chResp = await fetch(chUrl);
    const chData = await chResp.json();
    if (chData.error) return res.status(400).json({ error: chData.error.message });
    if (!chData.items || chData.items.length === 0) return res.status(404).json({ error: 'Channel not found' });

    const channel = chData.items[0];
    const stats = channel.statistics;

    // Fetch top videos (by viewCount)
    const searchUrl = 'https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=' + encodeURIComponent(channelId) + '&maxResults=10&order=viewCount&type=video&key=' + YT_API_KEY;
    const searchResp = await fetch(searchUrl);
    const searchData = await searchResp.json();

    let videos = [];
    if (searchData.items && searchData.items.length > 0) {
      const videoIds = searchData.items.map(v => v.id.videoId).join(',');
      const vidUrl = 'https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=' + videoIds + '&key=' + YT_API_KEY;
      const vidResp = await fetch(vidUrl);
      const vidData = await vidResp.json();
      videos = (vidData.items || []).map(v => ({
        id: v.id,
        title: v.snippet.title,
        thumbnail: v.snippet.thumbnails?.medium?.url || v.snippet.thumbnails?.default?.url,
        publishedAt: v.snippet.publishedAt,
        views: parseInt(v.statistics.viewCount || '0'),
        likes: parseInt(v.statistics.likeCount || '0'),
        comments: parseInt(v.statistics.commentCount || '0'),
        duration: v.contentDetails?.duration
      }));
    }

    // Fetch recent videos for growth trend
    const recentUrl = 'https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=' + encodeURIComponent(channelId) + '&maxResults=20&order=date&type=video&key=' + YT_API_KEY;
    const recentResp = await fetch(recentUrl);
    const recentData = await recentResp.json();

    let recentVideos = [];
    if (recentData.items && recentData.items.length > 0) {
      const recentIds = recentData.items.map(v => v.id.videoId).join(',');
      const rvUrl = 'https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=' + recentIds + '&key=' + YT_API_KEY;
      const rvResp = await fetch(rvUrl);
      const rvData = await rvResp.json();
      recentVideos = (rvData.items || []).map(v => ({
        title: v.snippet.title,
        publishedAt: v.snippet.publishedAt,
        views: parseInt(v.statistics.viewCount || '0'),
        likes: parseInt(v.statistics.likeCount || '0'),
        comments: parseInt(v.statistics.commentCount || '0')
      })).reverse();
    }

    const totalViews = parseInt(stats.viewCount || '0');
    const totalSubs = parseInt(stats.subscriberCount || '0');
    const totalVideos = parseInt(stats.videoCount || '0');
    const totalLikes = videos.reduce((s, v) => s + v.likes, 0);
    const totalVidViews = videos.reduce((s, v) => s + v.views, 0);
    const engagementRate = totalVidViews > 0 ? ((totalLikes / totalVidViews) * 100).toFixed(2) : 0;

    res.json({
      channel: {
        id: channelId,
        title: channel.snippet.title,
        description: channel.snippet.description,
        thumbnail: channel.snippet.thumbnails?.medium?.url,
        customUrl: channel.snippet.customUrl,
        subscriberCount: totalSubs,
        viewCount: totalViews,
        videoCount: totalVideos,
        hiddenSubscriberCount: stats.hiddenSubscriberCount,
      },
      topVideos: videos.slice(0, 5),
      recentVideos,
      engagementRate,
      estimatedRevenue: {
        low: (totalViews / 1000 * 1).toFixed(0),
        high: (totalViews / 1000 * 5).toFixed(0),
      }
    });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// --‚îÄ Pipeline Page (Kanban Board) --------------------------------------------
app.get('/pipeline', (req, res) => {
  res.send(`<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline -- Mission Control</title>
    ${NAV_STYLE}
    <style>
      .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
      .page-header h1 { font-size: 2.2rem; font-weight: 800; background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .page-header p { color: #5a6a8a; margin-top: 0.3rem; }
      .header-actions { display: flex; gap: 0.75rem; align-items: center; }
      .btn { padding: 0.65rem 1.4rem; border: none; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; font-family: inherit; transition: all 0.3s; }
      .btn-primary { background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%); color: white; }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3); }
      .search-box { padding: 0.6rem 1rem; background: rgba(15, 18, 35, 0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #e0e0e0; font-size: 0.85rem; font-family: inherit; outline: none; width: 200px; transition: border-color 0.3s; }
      .search-box:focus { border-color: rgba(0, 212, 255, 0.5); }
      .search-box::placeholder { color: #3a4a6a; }

      /* Kanban Board */
      .kanban { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem; align-items: flex-start; }
      @media (max-width: 1100px) { .kanban { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 600px) { .kanban { grid-template-columns: 1fr; } }
      .kanban-col {
        background: rgba(12, 15, 30, 0.5); backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.06); border-radius: 16px;
        min-height: 400px; display: flex; flex-direction: column;
        transition: all 0.3s;
      }
      .kanban-col.drag-over { border-color: rgba(0, 212, 255, 0.4); background: rgba(0, 212, 255, 0.03); box-shadow: 0 0 30px rgba(0, 212, 255, 0.08); }
      .col-header {
        padding: 1.25rem 1.25rem 0.75rem; display: flex; align-items: center; gap: 0.75rem;
        border-bottom: 1px solid rgba(255,255,255,0.04);
      }
      .col-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
      .col-name { font-weight: 700; font-size: 0.9rem; color: #c0d0e8; }
      .col-count { font-size: 0.72rem; color: #5a6a8a; background: rgba(255,255,255,0.04); padding: 0.15rem 0.5rem; border-radius: 50px; margin-left: auto; }
      .col-add { background: none; border: none; color: #3a4a6a; font-size: 1.1rem; cursor: pointer; padding: 0; line-height: 1; transition: color 0.3s; }
      .col-add:hover { color: #00d4ff; }
      .col-tasks { padding: 0.75rem; flex: 1; display: flex; flex-direction: column; gap: 0.6rem; min-height: 60px; }

      /* Task Cards */
      .task-card {
        background: rgba(20, 25, 50, 0.7); border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px; padding: 1rem; cursor: grab;
        transition: all 0.3s ease; position: relative; animation: cardIn 0.3s ease-out;
      }
      .task-card:hover { border-color: rgba(255,255,255,0.12); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
      .task-card.dragging { opacity: 0.4; transform: rotate(2deg) scale(0.95); }
      .task-card .priority-bar { position: absolute; top: 0; left: 12px; right: 12px; height: 2px; border-radius: 0 0 2px 2px; }
      .task-card .task-title { font-weight: 600; font-size: 0.88rem; color: #d0dae8; margin-bottom: 0.4rem; padding-top: 0.3rem; }
      .task-card .task-desc { font-size: 0.78rem; color: #5a6a8a; line-height: 1.5; margin-bottom: 0.6rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
      .task-meta { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
      .priority-tag { font-size: 0.65rem; font-weight: 600; padding: 0.15rem 0.5rem; border-radius: 50px; text-transform: uppercase; letter-spacing: 0.5px; }
      .priority-urgent { background: rgba(255, 71, 87, 0.15); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3); }
      .priority-high { background: rgba(255, 165, 2, 0.15); color: #ffa502; border: 1px solid rgba(255, 165, 2, 0.3); }
      .priority-medium { background: rgba(255, 211, 42, 0.15); color: #ffd32a; border: 1px solid rgba(255, 211, 42, 0.3); }
      .priority-low { background: rgba(46, 213, 115, 0.15); color: #2ed573; border: 1px solid rgba(46, 213, 115, 0.3); }
      .assignee-tag { font-size: 0.68rem; color: #7b8da8; background: rgba(255,255,255,0.05); padding: 0.15rem 0.5rem; border-radius: 50px; display: flex; align-items: center; gap: 0.3rem; }
      .due-tag { font-size: 0.65rem; color: #5a6a8a; margin-left: auto; }
      .task-actions { position: absolute; top: 0.6rem; right: 0.6rem; display: flex; gap: 0.25rem; opacity: 0; transition: opacity 0.2s; }
      .task-card:hover .task-actions { opacity: 1; }
      .task-action-btn { background: rgba(255,255,255,0.06); border: none; color: #5a6a8a; width: 24px; height: 24px; border-radius: 6px; cursor: pointer; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
      .task-action-btn:hover { background: rgba(255,255,255,0.12); color: #c0d0e8; }
      .task-action-btn.delete:hover { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
      @keyframes cardIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

      /* Modal */
      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: center; justify-content: center; animation: fadeIn 0.2s; }
      .modal-overlay.active { display: flex; }
      .modal { background: rgba(15, 18, 38, 0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 2rem; width: 90%; max-width: 480px; animation: slideUp 0.3s ease-out; }
      .modal h2 { font-size: 1.3rem; font-weight: 700; color: #c0d0e8; margin-bottom: 1.5rem; }
      .form-group { margin-bottom: 1rem; }
      .form-group label { display: block; font-size: 0.78rem; font-weight: 600; color: #5a6a8a; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.5px; }
      .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 0.7rem 1rem; background: rgba(10, 12, 25, 0.8);
        border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
        color: #e0e0e0; font-size: 0.9rem; font-family: inherit; outline: none;
        transition: border-color 0.3s;
      }
      .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: rgba(0, 212, 255, 0.5); }
      .form-group textarea { resize: vertical; min-height: 80px; }
      .form-group select option { background: #0a0e27; }
      .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
      .btn-ghost { background: rgba(255,255,255,0.05); color: #5a6a8a; border: 1px solid rgba(255,255,255,0.08); }
      .btn-ghost:hover { background: rgba(255,255,255,0.08); color: #c0d0e8; }
      .btn-danger { background: rgba(255, 71, 87, 0.15); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3); }
      .btn-danger:hover { background: rgba(255, 71, 87, 0.25); }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head><body>
    ${NAV_HTML}
    <div class="container">
      <div class="page-header">
        <div>
          <h1>üîÑ Pipeline</h1>
          <p>Drag & drop tasks across stages -- from idea to delivery</p>
        </div>
        <div class="header-actions">
          <input type="text" class="search-box" id="searchInput" placeholder="Search tasks..." oninput="filterTasks()" />
          <button class="btn btn-primary" onclick="openModal()">+ New Task</button>
        </div>
      </div>
      <div class="kanban" id="kanban">
        <div class="kanban-col" data-col="ideas" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'ideas')" ondragleave="handleDragLeave(event)">
          <div class="col-header"><div class="col-dot" style="background:#a29bfe"></div><span class="col-name">üí° Ideas</span><span class="col-count" id="count-ideas">0</span><button class="col-add" onclick="openModal('ideas')">+</button></div>
          <div class="col-tasks" id="tasks-ideas"></div>
        </div>
        <div class="kanban-col" data-col="in-progress" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'in-progress')" ondragleave="handleDragLeave(event)">
          <div class="col-header"><div class="col-dot" style="background:#3742fa"></div><span class="col-name">üöÄ In Progress</span><span class="col-count" id="count-in-progress">0</span><button class="col-add" onclick="openModal('in-progress')">+</button></div>
          <div class="col-tasks" id="tasks-in-progress"></div>
        </div>
        <div class="kanban-col" data-col="review" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'review')" ondragleave="handleDragLeave(event)">
          <div class="col-header"><div class="col-dot" style="background:#ffa502"></div><span class="col-name">üëÄ Review</span><span class="col-count" id="count-review">0</span><button class="col-add" onclick="openModal('review')">+</button></div>
          <div class="col-tasks" id="tasks-review"></div>
        </div>
        <div class="kanban-col" data-col="done" ondragover="handleDragOver(event)" ondrop="handleDrop(event, 'done')" ondragleave="handleDragLeave(event)">
          <div class="col-header"><div class="col-dot" style="background:#2ed573"></div><span class="col-name">‚úÖ Done</span><span class="col-count" id="count-done">0</span><button class="col-add" onclick="openModal('done')">+</button></div>
          <div class="col-tasks" id="tasks-done"></div>
        </div>
      </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
      <div class="modal">
        <h2 id="modalTitle">New Task</h2>
        <input type="hidden" id="taskId" />
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="taskTitleInput" placeholder="Task title..." />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="taskDesc" placeholder="Describe the task..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Priority</label>
            <select id="taskPriority"><option value="low">üü¢ Low</option><option value="medium" selected>üü° Medium</option><option value="high">üü† High</option><option value="urgent">üî¥ Urgent</option></select>
          </div>
          <div class="form-group">
            <label>Assignee</label>
            <input type="text" id="taskAssignee" placeholder="Name..." />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Due Date</label>
            <input type="date" id="taskDue" />
          </div>
          <div class="form-group">
            <label>Column</label>
            <select id="taskColumn"><option value="ideas">Ideas</option><option value="in-progress">In Progress</option><option value="review">Review</option><option value="done">Done</option></select>
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-danger" id="deleteBtn" style="display:none;margin-right:auto" onclick="deleteTask()">Delete</button>
          <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
        </div>
      </div>
    </div>

    <script>
      var tasks = JSON.parse(localStorage.getItem('mc_pipeline_tasks') || '[]');
      var draggedId = null;
      var searchTerm = '';

      // Seed demo tasks if empty
      if (tasks.length === 0) {
        tasks = [
          { id: 't1', title: 'Channel rebrand concept', desc: 'Explore new visual identity, thumbnails, and banner designs', priority: 'high', assignee: 'Luke', column: 'ideas', due: '', created: Date.now() },
          { id: 't2', title: 'Collaboration outreach list', desc: 'Research and compile list of 20 creators for potential collabs', priority: 'medium', assignee: '', column: 'ideas', due: '', created: Date.now() },
          { id: 't3', title: 'SEO keyword research', desc: 'Analyze top-performing keywords in the niche using TubeBuddy', priority: 'medium', assignee: 'AI', column: 'in-progress', due: '', created: Date.now() },
          { id: 't4', title: 'Film tutorial episode 12', desc: 'Script, film, and rough cut for the next tutorial installment', priority: 'urgent', assignee: 'Luke', column: 'in-progress', due: '2026-02-15', created: Date.now() },
          { id: 't5', title: 'Thumbnail A/B test results', desc: 'Review click-through rate data from last 5 thumbnail tests', priority: 'low', assignee: '', column: 'review', due: '', created: Date.now() },
          { id: 't6', title: 'Setup Shorts workflow', desc: 'Established repurposing pipeline from long-form to Shorts', priority: 'medium', assignee: 'Luke', column: 'done', due: '', created: Date.now() },
        ];
        saveTasks();
      }

      function saveTasks() { localStorage.setItem('mc_pipeline_tasks', JSON.stringify(tasks)); }
      function genId() { return 't' + Date.now() + Math.random().toString(36).substr(2, 5); }

      function renderBoard() {
        var cols = ['ideas', 'in-progress', 'review', 'done'];
        cols.forEach(function(col) {
          var container = document.getElementById('tasks-' + col);
          container.innerHTML = '';
          var colTasks = tasks.filter(function(t) {
            if (t.column !== col) return false;
            if (searchTerm && t.title.toLowerCase().indexOf(searchTerm) === -1 && (t.desc || '').toLowerCase().indexOf(searchTerm) === -1) return false;
            return true;
          });
          document.getElementById('count-' + col).textContent = colTasks.length;
          colTasks.forEach(function(task) {
            var card = document.createElement('div');
            card.className = 'task-card';
            card.draggable = true;
            card.dataset.id = task.id;
            card.ondragstart = function(e) { draggedId = task.id; card.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; };
            card.ondragend = function() { card.classList.remove('dragging'); draggedId = null; };
            card.ondblclick = function() { openModal(null, task.id); };

            var priorityColors = { urgent: '#ff4757', high: '#ffa502', medium: '#ffd32a', low: '#2ed573' };
            var pColor = priorityColors[task.priority] || '#5a6a8a';

            var dueStr = '';
            if (task.due) {
              var d = new Date(task.due + 'T00:00:00');
              dueStr = '<span class="due-tag">üìÖ ' + d.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' }) + '</span>';
            }

            var assigneeStr = '';
            if (task.assignee) {
              assigneeStr = '<span class="assignee-tag">üë§ ' + task.assignee + '</span>';
            }

            card.innerHTML = '<div class="priority-bar" style="background:' + pColor + '"></div>' +
              '<div class="task-actions">' +
                '<button class="task-action-btn" onclick="event.stopPropagation();openModal(null,\\'' + task.id + '\\')">‚úèÔ∏è</button>' +
                '<button class="task-action-btn delete" onclick="event.stopPropagation();deleteTaskById(\\'' + task.id + '\\')">üóë</button>' +
              '</div>' +
              '<div class="task-title">' + escHtml(task.title) + '</div>' +
              (task.desc ? '<div class="task-desc">' + escHtml(task.desc) + '</div>' : '') +
              '<div class="task-meta">' +
                '<span class="priority-tag priority-' + task.priority + '">' + task.priority + '</span>' +
                assigneeStr + dueStr +
              '</div>';
            container.appendChild(card);
          });
        });
      }

      function escHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

      function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; var col = e.currentTarget; col.classList.add('drag-over'); }
      function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
      function handleDrop(e, colName) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (!draggedId) return;
        var task = tasks.find(function(t) { return t.id === draggedId; });
        if (task) { task.column = colName; saveTasks(); renderBoard(); }
      }

      function filterTasks() {
        searchTerm = document.getElementById('searchInput').value.toLowerCase();
        renderBoard();
      }

      function openModal(col, editId) {
        document.getElementById('modalOverlay').classList.add('active');
        if (editId) {
          var task = tasks.find(function(t) { return t.id === editId; });
          if (!task) return;
          document.getElementById('modalTitle').textContent = 'Edit Task';
          document.getElementById('taskId').value = task.id;
          document.getElementById('taskTitleInput').value = task.title;
          document.getElementById('taskDesc').value = task.desc || '';
          document.getElementById('taskPriority').value = task.priority;
          document.getElementById('taskAssignee').value = task.assignee || '';
          document.getElementById('taskDue').value = task.due || '';
          document.getElementById('taskColumn').value = task.column;
          document.getElementById('deleteBtn').style.display = 'block';
        } else {
          document.getElementById('modalTitle').textContent = 'New Task';
          document.getElementById('taskId').value = '';
          document.getElementById('taskTitleInput').value = '';
          document.getElementById('taskDesc').value = '';
          document.getElementById('taskPriority').value = 'medium';
          document.getElementById('taskAssignee').value = '';
          document.getElementById('taskDue').value = '';
          document.getElementById('taskColumn').value = col || 'ideas';
          document.getElementById('deleteBtn').style.display = 'none';
        }
        setTimeout(function() { document.getElementById('taskTitleInput').focus(); }, 100);
      }

      function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

      function saveTask() {
        var title = document.getElementById('taskTitleInput').value.trim();
        if (!title) return;
        var id = document.getElementById('taskId').value;
        var data = {
          title: title,
          desc: document.getElementById('taskDesc').value.trim(),
          priority: document.getElementById('taskPriority').value,
          assignee: document.getElementById('taskAssignee').value.trim(),
          due: document.getElementById('taskDue').value,
          column: document.getElementById('taskColumn').value,
        };
        if (id) {
          var task = tasks.find(function(t) { return t.id === id; });
          if (task) Object.assign(task, data);
        } else {
          data.id = genId();
          data.created = Date.now();
          tasks.push(data);
        }
        saveTasks();
        renderBoard();
        closeModal();
      }

      function deleteTask() {
        var id = document.getElementById('taskId').value;
        if (id) { deleteTaskById(id); closeModal(); }
      }

      function deleteTaskById(id) {
        tasks = tasks.filter(function(t) { return t.id !== id; });
        saveTasks();
        renderBoard();
      }

      renderBoard();
    </script>
    <script>document.getElementById('nav-pipeline').classList.add('active');</script>
  </body></html>`);
});

// --‚îÄ Growth Page (YouTube Analytics Dashboard) ------------------------------
app.get('/growth', (req, res) => {
  res.send(`<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth -- Mission Control</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"><\/script>
    ${NAV_STYLE}
    <style>
      .page-header h1 { font-size: 2.2rem; font-weight: 800; background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .page-header p { color: #5a6a8a; margin-top: 0.3rem; }

      /* Setup Card */
      .setup-card {
        background: rgba(12, 15, 30, 0.7); backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.08); border-radius: 20px;
        padding: 3rem; text-align: center; max-width: 600px; margin: 3rem auto;
        animation: slideUp 0.4s ease-out;
      }
      .setup-card .icon { font-size: 3.5rem; margin-bottom: 1rem; }
      .setup-card h2 { color: #c0d0e8; font-size: 1.4rem; margin-bottom: 0.5rem; }
      .setup-card p { color: #5a6a8a; margin-bottom: 1.5rem; font-size: 0.9rem; }
      .setup-row { display: flex; gap: 0.75rem; max-width: 400px; margin: 0 auto; }
      .setup-row input { flex: 1; padding: 0.75rem 1rem; background: rgba(10, 12, 25, 0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #e0e0e0; font-size: 0.9rem; font-family: inherit; outline: none; }
      .setup-row input:focus { border-color: rgba(0, 212, 255, 0.5); }
      .setup-row input::placeholder { color: #3a4a6a; }
      .btn { padding: 0.7rem 1.5rem; border: none; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; font-family: inherit; transition: all 0.3s; }
      .btn-primary { background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%); color: white; }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3); }
      .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
      .btn-ghost { background: rgba(255,255,255,0.05); color: #5a6a8a; border: 1px solid rgba(255,255,255,0.08); }
      .btn-ghost:hover { color: #c0d0e8; }
      .search-results { margin-top: 1rem; text-align: left; }
      .ch-result {
        display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem;
        background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.3s;
      }
      .ch-result:hover { border-color: rgba(0, 212, 255, 0.3); background: rgba(0, 212, 255, 0.04); }
      .ch-result img { width: 40px; height: 40px; border-radius: 50%; }
      .ch-result .ch-name { font-weight: 600; color: #c0d0e8; font-size: 0.9rem; }
      .ch-result .ch-desc { font-size: 0.75rem; color: #5a6a8a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 350px; }

      /* Dashboard */
      .dashboard { display: none; animation: fadeIn 0.5s ease-out; }
      .dashboard.active { display: block; }
      .channel-bar {
        display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding: 1rem 1.5rem;
        background: rgba(12, 15, 30, 0.5); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px;
      }
      .channel-bar img { width: 48px; height: 48px; border-radius: 50%; border: 2px solid rgba(0, 212, 255, 0.3); }
      .channel-bar .ch-title { font-weight: 700; font-size: 1.1rem; color: #c0d0e8; }
      .channel-bar .ch-url { font-size: 0.78rem; color: #5a6a8a; }
      .channel-bar .ch-change { margin-left: auto; }

      /* Stat Cards */
      .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem; margin-bottom: 2rem; }
      @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
      .stat-card {
        background: rgba(12, 15, 30, 0.7); backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.06); border-radius: 16px;
        padding: 1.5rem; position: relative; overflow: hidden;
        transition: all 0.3s;
      }
      .stat-card:hover { border-color: rgba(255,255,255,0.12); transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.3); }
      .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--accent); }
      .stat-card .stat-icon { font-size: 1.5rem; margin-bottom: 0.75rem; }
      .stat-card .stat-value { font-size: 1.8rem; font-weight: 800; color: #e0e8f0; margin-bottom: 0.25rem; }
      .stat-card .stat-label { font-size: 0.78rem; color: #5a6a8a; text-transform: uppercase; letter-spacing: 0.5px; }

      /* Charts */
      .chart-row { display: grid; grid-template-columns: 2fr 1fr; gap: 1.25rem; margin-bottom: 2rem; }
      @media (max-width: 900px) { .chart-row { grid-template-columns: 1fr; } }
      .chart-card {
        background: rgba(12, 15, 30, 0.7); backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.06); border-radius: 16px;
        padding: 1.5rem;
      }
      .chart-card h3 { font-size: 1rem; font-weight: 700; color: #c0d0e8; margin-bottom: 1rem; }
      .chart-wrap { position: relative; height: 280px; }
      .revenue-card { display: flex; flex-direction: column; justify-content: center; }
      .revenue-range { text-align: center; }
      .revenue-range .rev-label { font-size: 0.8rem; color: #5a6a8a; margin-bottom: 0.5rem; }
      .revenue-range .rev-value { font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, #2ed573, #00d4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .revenue-range .rev-sub { font-size: 0.75rem; color: #3a4a6a; margin-top: 0.3rem; }
      .revenue-divider { width: 60px; height: 1px; background: rgba(255,255,255,0.08); margin: 1.5rem auto; }

      /* Videos */
      .videos-section { margin-bottom: 2rem; }
      .videos-section h3 { font-size: 1.1rem; font-weight: 700; color: #c0d0e8; margin-bottom: 1rem; }
      .video-list { display: flex; flex-direction: column; gap: 0.75rem; }
      .video-row {
        display: flex; align-items: center; gap: 1rem; padding: 1rem;
        background: rgba(12, 15, 30, 0.5); border: 1px solid rgba(255,255,255,0.05);
        border-radius: 14px; transition: all 0.3s; cursor: pointer;
      }
      .video-row:hover { border-color: rgba(0, 212, 255, 0.2); transform: translateX(4px); }
      .video-row .rank { font-size: 1.2rem; font-weight: 800; color: #3a4a6a; width: 30px; text-align: center; flex-shrink: 0; }
      .video-row .thumb { width: 120px; height: 68px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
      .video-row .vid-info { flex: 1; min-width: 0; }
      .video-row .vid-title { font-weight: 600; font-size: 0.88rem; color: #c0d0e8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.3rem; }
      .video-row .vid-date { font-size: 0.72rem; color: #4a5a6a; }
      .video-row .vid-stats { display: flex; gap: 1rem; flex-shrink: 0; }
      .video-row .vid-stat { text-align: right; }
      .video-row .vid-stat .val { font-weight: 700; font-size: 0.88rem; color: #c0d0e8; }
      .video-row .vid-stat .lbl { font-size: 0.65rem; color: #4a5a6a; text-transform: uppercase; }
      @media (max-width: 700px) { .video-row .thumb { display: none; } .video-row .vid-stats { flex-direction: column; gap: 0.3rem; } }

      /* Loading */
      .loading { text-align: center; padding: 4rem 2rem; }
      .spinner { width: 40px; height: 40px; border: 3px solid rgba(0, 212, 255, 0.2); border-top-color: #00d4ff; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .loading p { color: #5a6a8a; }
      .error-msg { background: rgba(255, 71, 87, 0.1); border: 1px solid rgba(255, 71, 87, 0.3); border-radius: 12px; padding: 1rem 1.5rem; color: #ff6b7a; font-size: 0.9rem; margin: 1rem 0; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head><body>
    ${NAV_HTML}
    <div class="container">
      <div class="page-header" style="margin-bottom:1.5rem">
        <h1>üìà Growth Dashboard</h1>
        <p>YouTube analytics -- track subscribers, views, engagement & revenue</p>
      </div>

      <div id="setupView">
        <div class="setup-card">
          <div class="icon">üì∫</div>
          <h2>Connect Your YouTube Channel</h2>
          <p>Search for your channel to load analytics</p>
          <div class="setup-row">
            <input type="text" id="channelSearch" placeholder="Search channel name or paste ID..." onkeydown="if(event.key==='Enter')searchChannel()" />
            <button class="btn btn-primary" id="searchBtn" onclick="searchChannel()">Search</button>
          </div>
          <div id="searchResults" class="search-results"></div>
        </div>
      </div>

      <div id="loadingView" style="display:none">
        <div class="loading"><div class="spinner"></div><p>Loading analytics...</p></div>
      </div>

      <div class="dashboard" id="dashboardView">
        <div class="channel-bar" id="channelBar"></div>
        <div class="stats-grid" id="statsGrid"></div>
        <div class="chart-row">
          <div class="chart-card">
            <h3>üìä Views Per Video (Recent)</h3>
            <div class="chart-wrap"><canvas id="viewsChart"></canvas></div>
          </div>
          <div class="chart-card revenue-card">
            <h3>üí∞ Estimated Revenue</h3>
            <div id="revenueDisplay"></div>
          </div>
        </div>
        <div class="chart-row" style="grid-template-columns: 1fr 1fr">
          <div class="chart-card">
            <h3>üí¨ Engagement Per Video</h3>
            <div class="chart-wrap"><canvas id="engagementChart"></canvas></div>
          </div>
          <div class="chart-card">
            <h3>üëç Likes Per Video</h3>
            <div class="chart-wrap"><canvas id="likesChart"></canvas></div>
          </div>
        </div>
        <div class="videos-section">
          <h3>üèÜ Top 5 Videos</h3>
          <div class="video-list" id="videoList"></div>
        </div>
      </div>
      <div id="errorArea"></div>
    </div>

    <script>
      var channelId = localStorage.getItem('mc_yt_channel_id') || '';
      var channelName = localStorage.getItem('mc_yt_channel_name') || '';
      var viewsChartInstance = null;
      var engagementChartInstance = null;
      var likesChartInstance = null;

      if (channelId) { loadDashboard(channelId); }

      function searchChannel() {
        var q = document.getElementById('channelSearch').value.trim();
        if (!q) return;
        // If it looks like a channel ID, load directly
        if (q.startsWith('UC') && q.length > 20) {
          selectChannel(q, q);
          return;
        }
        document.getElementById('searchBtn').disabled = true;
        document.getElementById('searchBtn').textContent = 'Searching...';
        fetch('/api/youtube/search?q=' + encodeURIComponent(q))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('searchBtn').textContent = 'Search';
            if (data.error) { showError(data.error); return; }
            var html = '';
            (data.channels || []).forEach(function(ch) {
              html += '<div class="ch-result" onclick="selectChannel(\\'' + ch.id + '\\', \\'' + escAttr(ch.title) + '\\')">' +
                (ch.thumbnail ? '<img src="' + ch.thumbnail + '" alt="" />' : '') +
                '<div><div class="ch-name">' + escH(ch.title) + '</div><div class="ch-desc">' + escH(ch.description || '') + '</div></div></div>';
            });
            if (!html) html = '<p style="color:#5a6a8a;text-align:center;padding:1rem">No channels found</p>';
            document.getElementById('searchResults').innerHTML = html;
          })
          .catch(function(err) {
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('searchBtn').textContent = 'Search';
            showError(err.message);
          });
      }

      function selectChannel(id, name) {
        channelId = id;
        channelName = name || id;
        localStorage.setItem('mc_yt_channel_id', id);
        localStorage.setItem('mc_yt_channel_name', name || id);
        loadDashboard(id);
      }

      function loadDashboard(id) {
        document.getElementById('setupView').style.display = 'none';
        document.getElementById('loadingView').style.display = 'block';
        document.getElementById('dashboardView').classList.remove('active');
        document.getElementById('errorArea').innerHTML = '';

        fetch('/api/youtube/dashboard?channelId=' + encodeURIComponent(id))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            document.getElementById('loadingView').style.display = 'none';
            if (data.error) {
              showError(data.error);
              document.getElementById('setupView').style.display = 'block';
              return;
            }
            renderDashboard(data);
          })
          .catch(function(err) {
            document.getElementById('loadingView').style.display = 'none';
            document.getElementById('setupView').style.display = 'block';
            showError(err.message);
          });
      }

      function renderDashboard(data) {
        var ch = data.channel;
        localStorage.setItem('mc_yt_channel_name', ch.title);

        // Channel bar
        document.getElementById('channelBar').innerHTML =
          (ch.thumbnail ? '<img src="' + ch.thumbnail + '" alt="" />' : '') +
          '<div><div class="ch-title">' + escH(ch.title) + '</div>' +
          '<div class="ch-url">' + escH(ch.customUrl || ch.id) + '</div></div>' +
          '<button class="btn btn-ghost ch-change" onclick="changeChannel()">Change Channel</button>';

        // Stats
        document.getElementById('statsGrid').innerHTML =
          statCard('üë•', formatNum(ch.subscriberCount), 'Subscribers', '#00d4ff') +
          statCard('üëÅÔ∏è', formatNum(ch.viewCount), 'Total Views', '#7b2ff7') +
          statCard('üé¨', formatNum(ch.videoCount), 'Videos', '#2ed573') +
          statCard('üí¨', data.engagementRate + '%', 'Engagement Rate', '#ffa502');

        // Revenue
        document.getElementById('revenueDisplay').innerHTML =
          '<div class="revenue-range">' +
            '<div class="rev-label">Estimated Lifetime</div>' +
            '<div class="rev-value">$' + formatNum(parseInt(data.estimatedRevenue.low)) + ' -- $' + formatNum(parseInt(data.estimatedRevenue.high)) + '</div>' +
            '<div class="rev-sub">Based on $1-$5 CPM</div>' +
          '</div>' +
          '<div class="revenue-divider"></div>' +
          '<div class="revenue-range">' +
            '<div class="rev-label">Per 1K Views</div>' +
            '<div class="rev-value">$1 -- $5</div>' +
            '<div class="rev-sub">Industry average CPM</div>' +
          '</div>';

        // Top videos
        var vhtml = '';
        data.topVideos.forEach(function(v, i) {
          vhtml += '<div class="video-row" onclick="window.open(\\'https://youtube.com/watch?v=' + v.id + '\\',\\'_blank\\')">' +
            '<span class="rank">#' + (i + 1) + '</span>' +
            (v.thumbnail ? '<img class="thumb" src="' + v.thumbnail + '" alt="" />' : '') +
            '<div class="vid-info"><div class="vid-title">' + escH(v.title) + '</div>' +
            '<div class="vid-date">' + new Date(v.publishedAt).toLocaleDateString('en-AU', { year: 'numeric', month: 'short', day: 'numeric' }) + '</div></div>' +
            '<div class="vid-stats">' +
              '<div class="vid-stat"><div class="val">' + formatNum(v.views) + '</div><div class="lbl">Views</div></div>' +
              '<div class="vid-stat"><div class="val">' + formatNum(v.likes) + '</div><div class="lbl">Likes</div></div>' +
              '<div class="vid-stat"><div class="val">' + formatNum(v.comments) + '</div><div class="lbl">Comments</div></div>' +
            '</div></div>';
        });
        document.getElementById('videoList').innerHTML = vhtml || '<p style="color:#5a6a8a">No videos found</p>';

        // Charts
        renderCharts(data.recentVideos || []);
        document.getElementById('dashboardView').classList.add('active');
      }

      function renderCharts(videos) {
        var labels = videos.map(function(v) { return v.title.length > 20 ? v.title.substr(0, 20) + '...' : v.title; });
        var views = videos.map(function(v) { return v.views; });
        var likes = videos.map(function(v) { return v.likes; });
        var comments = videos.map(function(v) { return v.comments; });
        var engagement = videos.map(function(v) { return v.views > 0 ? (((v.likes + v.comments) / v.views) * 100).toFixed(2) : 0; });

        var chartDefaults = {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: '#4a5a6a', maxRotation: 45, font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.03)' } },
            y: { ticks: { color: '#4a5a6a', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } }
          }
        };

        if (viewsChartInstance) viewsChartInstance.destroy();
        viewsChartInstance = new Chart(document.getElementById('viewsChart'), {
          type: 'bar',
          data: { labels: labels, datasets: [{ data: views, backgroundColor: 'rgba(0, 212, 255, 0.4)', borderColor: '#00d4ff', borderWidth: 1, borderRadius: 6 }] },
          options: chartDefaults
        });

        if (engagementChartInstance) engagementChartInstance.destroy();
        engagementChartInstance = new Chart(document.getElementById('engagementChart'), {
          type: 'line',
          data: { labels: labels, datasets: [{ data: engagement, borderColor: '#ffa502', backgroundColor: 'rgba(255, 165, 2, 0.1)', fill: true, tension: 0.4, pointRadius: 4, pointBackgroundColor: '#ffa502' }] },
          options: chartDefaults
        });

        if (likesChartInstance) likesChartInstance.destroy();
        likesChartInstance = new Chart(document.getElementById('likesChart'), {
          type: 'bar',
          data: { labels: labels, datasets: [{ data: likes, backgroundColor: 'rgba(123, 47, 247, 0.4)', borderColor: '#7b2ff7', borderWidth: 1, borderRadius: 6 }] },
          options: chartDefaults
        });
      }

      function changeChannel() {
        localStorage.removeItem('mc_yt_channel_id');
        localStorage.removeItem('mc_yt_channel_name');
        channelId = '';
        document.getElementById('dashboardView').classList.remove('active');
        document.getElementById('setupView').style.display = 'block';
        document.getElementById('searchResults').innerHTML = '';
        document.getElementById('channelSearch').value = '';
      }

      function statCard(icon, value, label, accent) {
        return '<div class="stat-card" style="--accent:' + accent + '">' +
          '<div class="stat-icon">' + icon + '</div>' +
          '<div class="stat-value">' + value + '</div>' +
          '<div class="stat-label">' + label + '</div></div>';
      }

      function formatNum(n) {
        if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
        if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
        return String(n);
      }
      function escH(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
      function escAttr(s) { return s.replace(/'/g, "\\\\'").replace(/"/g, '&quot;'); }
      function showError(msg) {
        document.getElementById('errorArea').innerHTML = '<div class="error-msg">' + escH(msg) + '</div>';
      }
    </script>
    <script>document.getElementById('nav-growth').classList.add('active');</script>
  </body></html>`);
});

// --‚îÄ Content Page (Content Calendar) ----------------------------------------‚îÄ
app.get('/content', (req, res) => {
  res.send(`<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content -- Mission Control</title>
    ${NAV_STYLE}
    <style>
      .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
      .page-header h1 { font-size: 2.2rem; font-weight: 800; background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .page-header p { color: #5a6a8a; margin-top: 0.3rem; }
      .header-actions { display: flex; gap: 0.75rem; align-items: center; }
      .btn { padding: 0.65rem 1.4rem; border: none; border-radius: 10px; font-weight: 600; font-size: 0.85rem; cursor: pointer; font-family: inherit; transition: all 0.3s; }
      .btn-primary { background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%); color: white; }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3); }
      .btn-ghost { background: rgba(255,255,255,0.05); color: #5a6a8a; border: 1px solid rgba(255,255,255,0.08); }
      .btn-ghost:hover { background: rgba(255,255,255,0.08); color: #c0d0e8; }
      .btn-icon { background: none; border: none; color: #5a6a8a; font-size: 1.2rem; cursor: pointer; padding: 0.3rem; transition: color 0.3s; }
      .btn-icon:hover { color: #00d4ff; }

      /* Calendar Navigation */
      .cal-nav { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
      .cal-nav h2 { font-size: 1.4rem; font-weight: 700; color: #c0d0e8; min-width: 200px; }
      .view-toggle { display: flex; gap: 0; background: rgba(15, 18, 35, 0.6); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; overflow: hidden; margin-left: auto; }
      .view-toggle button { padding: 0.5rem 1rem; background: none; border: none; color: #5a6a8a; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; }
      .view-toggle button.active { background: rgba(0, 212, 255, 0.15); color: #00d4ff; }

      /* Calendar Grid */
      .cal-grid {
        display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px;
        background: rgba(255,255,255,0.03); border-radius: 16px; overflow: hidden;
        border: 1px solid rgba(255,255,255,0.06);
      }
      .cal-day-header {
        padding: 0.75rem; text-align: center; font-size: 0.75rem; font-weight: 700;
        color: #5a6a8a; text-transform: uppercase; letter-spacing: 1px;
        background: rgba(12, 15, 30, 0.8);
      }
      .cal-day {
        min-height: 120px; padding: 0.5rem; background: rgba(12, 15, 30, 0.5);
        transition: all 0.3s; position: relative; vertical-align: top;
      }
      .cal-day:hover { background: rgba(12, 15, 30, 0.8); }
      .cal-day.other-month { opacity: 0.3; }
      .cal-day.today { background: rgba(0, 212, 255, 0.04); }
      .cal-day.today::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #00d4ff, #7b2ff7); }
      .cal-day.drag-over { background: rgba(0, 212, 255, 0.08); box-shadow: inset 0 0 20px rgba(0, 212, 255, 0.1); }
      .day-num { font-size: 0.82rem; font-weight: 600; color: #5a6a8a; margin-bottom: 0.4rem; }
      .cal-day.today .day-num { color: #00d4ff; }
      .day-add { position: absolute; top: 0.4rem; right: 0.4rem; background: none; border: none; color: #2a3a5a; font-size: 0.9rem; cursor: pointer; opacity: 0; transition: opacity 0.2s; line-height: 1; }
      .cal-day:hover .day-add { opacity: 1; }
      .day-add:hover { color: #00d4ff; }

      /* Content Cards */
      .content-chip {
        padding: 0.3rem 0.5rem; margin-bottom: 0.3rem;
        border-radius: 6px; font-size: 0.7rem; font-weight: 600;
        cursor: grab; transition: all 0.2s; white-space: nowrap;
        overflow: hidden; text-overflow: ellipsis; display: block;
        border-left: 3px solid var(--type-color);
        background: rgba(255,255,255,0.03);
        color: #b0c4de;
      }
      .content-chip:hover { background: rgba(255,255,255,0.06); transform: translateX(2px); }
      .content-chip.dragging { opacity: 0.4; }

      /* Type Colors */
      .type-video { --type-color: #3742fa; }
      .type-short { --type-color: #a29bfe; }
      .type-livestream { --type-color: #ff4757; }
      .type-community { --type-color: #2ed573; }

      /* List View */
      .list-view { display: none; }
      .list-view.active { display: block; }
      .cal-view.active { display: grid; }
      .cal-view { display: none; }
      .list-item {
        display: flex; align-items: center; gap: 1rem; padding: 1rem 1.25rem;
        background: rgba(12, 15, 30, 0.5); border: 1px solid rgba(255,255,255,0.05);
        border-radius: 14px; margin-bottom: 0.6rem; transition: all 0.3s;
        cursor: pointer; animation: cardIn 0.3s ease-out;
      }
      .list-item:hover { border-color: rgba(255,255,255,0.1); transform: translateX(4px); }
      .list-type { width: 8px; height: 40px; border-radius: 4px; flex-shrink: 0; }
      .list-info { flex: 1; min-width: 0; }
      .list-title { font-weight: 600; font-size: 0.9rem; color: #c0d0e8; margin-bottom: 0.2rem; }
      .list-desc { font-size: 0.78rem; color: #5a6a8a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .list-meta { display: flex; gap: 0.75rem; flex-shrink: 0; align-items: center; }
      .list-date { font-size: 0.78rem; color: #5a6a8a; white-space: nowrap; }
      .status-badge { font-size: 0.65rem; font-weight: 600; padding: 0.2rem 0.6rem; border-radius: 50px; text-transform: uppercase; letter-spacing: 0.5px; }
      .status-idea { background: rgba(162, 155, 254, 0.15); color: #a29bfe; }
      .status-scripting { background: rgba(0, 212, 255, 0.15); color: #00d4ff; }
      .status-filming { background: rgba(255, 165, 2, 0.15); color: #ffa502; }
      .status-editing { background: rgba(253, 121, 168, 0.15); color: #fd79a8; }
      .status-scheduled { background: rgba(55, 66, 250, 0.15); color: #3742fa; }
      .status-published { background: rgba(46, 213, 115, 0.15); color: #2ed573; }
      .type-badge { font-size: 0.65rem; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 50px; }

      /* Modal */
      .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: center; justify-content: center; }
      .modal-overlay.active { display: flex; }
      .modal { background: rgba(15, 18, 38, 0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 2rem; width: 90%; max-width: 520px; animation: slideUp 0.3s ease-out; }
      .modal h2 { font-size: 1.3rem; font-weight: 700; color: #c0d0e8; margin-bottom: 1.5rem; }
      .form-group { margin-bottom: 1rem; }
      .form-group label { display: block; font-size: 0.78rem; font-weight: 600; color: #5a6a8a; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.5px; }
      .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 0.7rem 1rem; background: rgba(10, 12, 25, 0.8);
        border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
        color: #e0e0e0; font-size: 0.9rem; font-family: inherit; outline: none;
        transition: border-color 0.3s;
      }
      .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: rgba(0, 212, 255, 0.5); }
      .form-group textarea { resize: vertical; min-height: 100px; }
      .form-group select option { background: #0a0e27; }
      .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
      .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
      .btn-danger { background: rgba(255, 71, 87, 0.15); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.3); }
      .btn-danger:hover { background: rgba(255, 71, 87, 0.25); }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes cardIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head><body>
    ${NAV_HTML}
    <div class="container">
      <div class="page-header">
        <div>
          <h1>‚úçÔ∏è Content Calendar</h1>
          <p>Plan, schedule, and track your content pipeline</p>
        </div>
        <div class="header-actions">
          <div class="view-toggle">
            <button id="viewCalBtn" class="active" onclick="setView('calendar')">üìÖ Calendar</button>
            <button id="viewListBtn" onclick="setView('list')">üìã List</button>
          </div>
          <button class="btn btn-ghost" id="syncBtn" onclick="syncFromServer()" style="display:flex;align-items:center;gap:0.4rem">üîÑ Sync</button>
          <button class="btn btn-ghost" id="autoGenBtn" onclick="autoGenerateContent()" style="display:flex;align-items:center;gap:0.4rem">ü§ñ Auto-Generate 30 Days</button>
          <button class="btn btn-primary" onclick="openContentModal()">+ New Content</button>
        </div>
      </div>

      <div class="cal-nav">
        <button class="btn-icon" onclick="changeMonth(-1)">‚óÄ</button>
        <h2 id="calMonthLabel"></h2>
        <button class="btn-icon" onclick="changeMonth(1)">‚ñ∂</button>
        <button class="btn btn-ghost" onclick="goToday()">Today</button>
      </div>

      <div class="cal-view active cal-grid" id="calGrid"></div>

      <div class="list-view" id="listView"></div>
    </div>

    <!-- Content Modal -->
    <div class="modal-overlay" id="contentModalOverlay" onclick="if(event.target===this)closeContentModal()">
      <div class="modal">
        <h2 id="contentModalTitle">New Content</h2>
        <input type="hidden" id="contentId" />
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="contentTitle" placeholder="Video title or idea..." />
        </div>
        <div class="form-row-3">
          <div class="form-group">
            <label>Type</label>
            <select id="contentType"><option value="video">üé¨ Video</option><option value="short">üì± Short</option><option value="livestream">üî¥ Livestream</option><option value="community">üí¨ Community</option></select>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="contentStatus"><option value="idea">üí° Idea</option><option value="scripting">‚úçÔ∏è Scripting</option><option value="filming">üé• Filming</option><option value="editing">‚úÇÔ∏è Editing</option><option value="scheduled">üìÖ Scheduled</option><option value="published">‚úÖ Published</option></select>
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="contentDate" />
          </div>
        </div>
        <div class="form-group">
          <label>Script / Notes</label>
          <textarea id="contentNotes" placeholder="Script outline, talking points, notes..."></textarea>
        </div>
        <div class="form-group">
          <label>Tags (comma-separated)</label>
          <input type="text" id="contentTags" placeholder="tutorial, tech, review..." />
        </div>
        <div class="modal-actions">
          <button class="btn btn-danger" id="contentDeleteBtn" style="display:none;margin-right:auto" onclick="deleteContent()">Delete</button>
          <button class="btn btn-ghost" onclick="closeContentModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveContent()">Save</button>
        </div>
      </div>
    </div>

    <script>
      var items = [];
      var currentYear, currentMonth;
      var currentView = 'calendar';
      var draggedContentId = null;
      var isLoading = true;

      function dateStr(y, m, d) { return y + '-' + String(m + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0'); }
      function genId() { return 'c' + Date.now() + Math.random().toString(36).substr(2, 5); }

      // -- API-backed persistence --
      function saveItems() {
        // Also cache locally for offline fallback
        localStorage.setItem('mc_content_items', JSON.stringify(items));
      }

      async function loadItemsFromAPI() {
        try {
          var resp = await fetch('/api/content/items');
          if (resp.ok) {
            var data = await resp.json();
            if (Array.isArray(data) && data.length > 0) {
              items = data;
              saveItems(); // cache locally
              return true;
            }
          }
        } catch (e) {
          console.warn('API fetch failed, using local cache:', e);
        }
        // Fallback to localStorage
        items = JSON.parse(localStorage.getItem('mc_content_items') || '[]');
        return false;
      }

      async function apiCreateItem(item) {
        try {
          var resp = await fetch('/api/content/items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
          });
          if (resp.ok) return await resp.json();
        } catch (e) { console.warn('API create failed:', e); }
        return null;
      }

      async function apiUpdateItem(id, data) {
        try {
          var resp = await fetch('/api/content/items/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          if (resp.ok) return await resp.json();
        } catch (e) { console.warn('API update failed:', e); }
        return null;
      }

      async function apiDeleteItem(id) {
        try {
          var resp = await fetch('/api/content/items/' + id, { method: 'DELETE' });
          return resp.ok;
        } catch (e) { console.warn('API delete failed:', e); return false; }
      }

      async function syncFromServer() {
        var syncBtn = document.getElementById('syncBtn');
        if (syncBtn) { syncBtn.textContent = '‚è≥ Syncing...'; syncBtn.disabled = true; }
        var ok = await loadItemsFromAPI();
        renderCalendar();
        renderList();
        if (syncBtn) { syncBtn.textContent = ok ? '‚úÖ Synced' : '‚ö†Ô∏è Offline'; syncBtn.disabled = false; setTimeout(function(){ syncBtn.textContent = 'üîÑ Sync'; }, 2000); }
      }

      // Init to current month + load from API
      var now = new Date();
      currentYear = now.getFullYear();
      currentMonth = now.getMonth();

      // Load from API first, then render
      (async function() {
        await loadItemsFromAPI();
        isLoading = false;
        renderCalendar();
        renderList();
      })();

      function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        renderCalendar();
      }

      function goToday() {
        var n = new Date();
        currentYear = n.getFullYear();
        currentMonth = n.getMonth();
        renderCalendar();
      }

      function setView(v) {
        currentView = v;
        document.getElementById('viewCalBtn').classList.toggle('active', v === 'calendar');
        document.getElementById('viewListBtn').classList.toggle('active', v === 'list');
        document.querySelector('.cal-view').classList.toggle('active', v === 'calendar');
        document.getElementById('listView').classList.toggle('active', v === 'list');
        if (v === 'list') renderList();
      }

      function renderCalendar() {
        var monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        document.getElementById('calMonthLabel').textContent = monthNames[currentMonth] + ' ' + currentYear;

        var grid = document.getElementById('calGrid');
        var html = '';
        var dayNames = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
        dayNames.forEach(function(d) { html += '<div class="cal-day-header">' + d + '</div>'; });

        var firstDay = new Date(currentYear, currentMonth, 1);
        var startDow = (firstDay.getDay() + 6) % 7; // Monday = 0
        var daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        var prevDays = new Date(currentYear, currentMonth, 0).getDate();

        var todayStr = new Date().toISOString().split('T')[0];
        var totalCells = Math.ceil((startDow + daysInMonth) / 7) * 7;

        for (var i = 0; i < totalCells; i++) {
          var dayNum, dateKey, isOther = false;
          if (i < startDow) {
            dayNum = prevDays - startDow + 1 + i;
            var pm = currentMonth === 0 ? 11 : currentMonth - 1;
            var py = currentMonth === 0 ? currentYear - 1 : currentYear;
            dateKey = dateStr(py, pm, dayNum);
            isOther = true;
          } else if (i >= startDow + daysInMonth) {
            dayNum = i - startDow - daysInMonth + 1;
            var nm = currentMonth === 11 ? 0 : currentMonth + 1;
            var ny = currentMonth === 11 ? currentYear + 1 : currentYear;
            dateKey = dateStr(ny, nm, dayNum);
            isOther = true;
          } else {
            dayNum = i - startDow + 1;
            dateKey = dateStr(currentYear, currentMonth, dayNum);
          }

          var isToday = dateKey === todayStr;
          var cls = 'cal-day' + (isOther ? ' other-month' : '') + (isToday ? ' today' : '');

          var dayItems = items.filter(function(it) { return it.date === dateKey; });
          var chipsHtml = '';
          dayItems.forEach(function(it) {
            chipsHtml += '<div class="content-chip type-' + it.type + '" draggable="true" data-id="' + it.id + '" ' +
              'ondragstart="startDragContent(event, \\'' + it.id + '\\')" ondragend="endDragContent(event)" ' +
              'ondblclick="openContentModal(\\'' + it.id + '\\')" title="' + escAttr(it.title) + '">' +
              typeIcon(it.type) + ' ' + escH(it.title) + '</div>';
          });

          html += '<div class="' + cls + '" data-date="' + dateKey + '" ' +
            'ondragover="event.preventDefault();this.classList.add(\\'drag-over\\')" ' +
            'ondragleave="this.classList.remove(\\'drag-over\\')" ' +
            'ondrop="dropOnDay(event, \\'' + dateKey + '\\')">' +
            '<div class="day-num">' + dayNum + '</div>' +
            '<button class="day-add" onclick="openContentModal(null, \\'' + dateKey + '\\')">+</button>' +
            chipsHtml + '</div>';
        }
        grid.innerHTML = html;
      }

      function renderList() {
        var sorted = items.slice().sort(function(a, b) {
          if (!a.date && !b.date) return 0;
          if (!a.date) return 1;
          if (!b.date) return -1;
          return a.date.localeCompare(b.date);
        });

        var typeColors = { video: '#3742fa', short: '#a29bfe', livestream: '#ff4757', community: '#2ed573' };
        var html = '';
        sorted.forEach(function(it) {
          var dateLabel = it.date ? new Date(it.date + 'T00:00:00').toLocaleDateString('en-AU', { weekday: 'short', month: 'short', day: 'numeric' }) : 'Unscheduled';
          html += '<div class="list-item" ondblclick="openContentModal(\\'' + it.id + '\\')">' +
            '<div class="list-type" style="background:' + (typeColors[it.type] || '#5a6a8a') + '"></div>' +
            '<div class="list-info"><div class="list-title">' + typeIcon(it.type) + ' ' + escH(it.title) + '</div>' +
            '<div class="list-desc">' + escH(it.notes || 'No notes') + '</div></div>' +
            '<div class="list-meta">' +
              '<span class="status-badge status-' + it.status + '">' + it.status + '</span>' +
              '<span class="list-date">' + dateLabel + '</span>' +
            '</div></div>';
        });
        if (!html) html = '<p style="color:#5a6a8a;text-align:center;padding:3rem">No content yet -- click + New Content to get started</p>';
        document.getElementById('listView').innerHTML = html;
      }

      function typeIcon(t) {
        var icons = { video: 'üé¨', short: 'üì±', livestream: 'üî¥', community: 'üí¨' };
        return icons[t] || 'üìÑ';
      }

      function startDragContent(e, id) {
        draggedContentId = id;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      }
      function endDragContent(e) { e.target.classList.remove('dragging'); draggedContentId = null; }
      function dropOnDay(e, dateKey) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (!draggedContentId) return;
        var item = items.find(function(i) { return i.id === draggedContentId; });
        if (item) { item.date = dateKey; saveItems(); apiUpdateItem(item.id, { date: dateKey }); renderCalendar(); renderList(); }
      }

      function openContentModal(editId, preDate) {
        document.getElementById('contentModalOverlay').classList.add('active');
        if (editId) {
          var item = items.find(function(i) { return i.id === editId; });
          if (!item) return;
          document.getElementById('contentModalTitle').textContent = 'Edit Content';
          document.getElementById('contentId').value = item.id;
          document.getElementById('contentTitle').value = item.title;
          document.getElementById('contentType').value = item.type;
          document.getElementById('contentStatus').value = item.status;
          document.getElementById('contentDate').value = item.date || '';
          document.getElementById('contentNotes').value = item.notes || '';
          document.getElementById('contentTags').value = item.tags || '';
          document.getElementById('contentDeleteBtn').style.display = 'block';
        } else {
          document.getElementById('contentModalTitle').textContent = 'New Content';
          document.getElementById('contentId').value = '';
          document.getElementById('contentTitle').value = '';
          document.getElementById('contentType').value = 'video';
          document.getElementById('contentStatus').value = 'idea';
          document.getElementById('contentDate').value = preDate || '';
          document.getElementById('contentNotes').value = '';
          document.getElementById('contentTags').value = '';
          document.getElementById('contentDeleteBtn').style.display = 'none';
        }
        setTimeout(function() { document.getElementById('contentTitle').focus(); }, 100);
      }

      function closeContentModal() { document.getElementById('contentModalOverlay').classList.remove('active'); }

      async function saveContent() {
        var title = document.getElementById('contentTitle').value.trim();
        if (!title) return;
        var id = document.getElementById('contentId').value;
        var data = {
          title: title,
          type: document.getElementById('contentType').value,
          status: document.getElementById('contentStatus').value,
          date: document.getElementById('contentDate').value,
          notes: document.getElementById('contentNotes').value.trim(),
          tags: document.getElementById('contentTags').value.trim(),
        };
        if (id) {
          // Update existing
          var item = items.find(function(i) { return i.id === id; });
          if (item) Object.assign(item, data);
          apiUpdateItem(id, data); // fire and forget
        } else {
          // Create new
          data.id = genId();
          data.created = Date.now();
          items.push(data);
          apiCreateItem(data); // fire and forget
        }
        saveItems();
        renderCalendar();
        renderList();
        closeContentModal();
      }

      async function deleteContent() {
        var id = document.getElementById('contentId').value;
        if (id) {
          items = items.filter(function(i) { return i.id !== id; });
          saveItems();
          apiDeleteItem(id); // fire and forget
          renderCalendar();
          renderList();
          closeContentModal();
        }
      }

      function escH(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
      function escAttr(s) { return s.replace(/'/g, "\\\\'").replace(/"/g, '&quot;'); }

      // Auto-generate content
      async function autoGenerateContent() {
        var btn = document.getElementById('autoGenBtn');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Generating...';
        try {
          var res = await fetch('/api/content/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ niche: 'tech, AI, content creation, entrepreneurship' })
          });
          var data = await res.json();
          if (data.error) { alert('Error: ' + data.error); return; }
          if (data.items && data.items.length > 0) {
            data.items.forEach(function(item) {
              item.id = genId();
              item.created = Date.now();
              items.push(item);
            });
            saveItems();
            // Bulk push to backend
            fetch('/api/content/items/bulk', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data.items.map(function(it) { return items.find(function(i) { return i.title === it.title; }) || it; }))
            }).catch(function(){});
            renderCalendar();
            renderList();
            alert('‚úÖ Generated ' + data.items.length + ' content ideas!');
          }
        } catch (err) {
          alert('Failed to generate: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = 'ü§ñ Auto-Generate 30 Days';
        }
      }
    </script>
    <script>document.getElementById('nav-content').classList.add('active');</script>
  </body></html>`);
});

// --‚îÄ PWA: Manifest ----------------------------------------------------------‚îÄ
app.get('/manifest.json', (req, res) => {
  res.setHeader('Content-Type', 'application/manifest+json');
  res.json({
    name: 'Mission Control',
    short_name: 'Mission Ctrl',
    description: 'AI-powered operations dashboard -- 8-agent council led by Jarvis',
    start_url: '/',
    display: 'standalone',
    background_color: '#0a0e27',
    theme_color: '#0a0e27',
    orientation: 'any',
    icons: [
      { src: '/api/icon/192', sizes: '192x192', type: 'image/png' },
      { src: '/api/icon/512', sizes: '512x512', type: 'image/png' },
      { src: '/api/icon/180', sizes: '180x180', type: 'image/png', purpose: 'apple touch icon' },
      { src: '/api/icon/512', sizes: '512x512', type: 'image/png', purpose: 'maskable' },
    ],
    categories: ['productivity', 'business'],
    shortcuts: [
      { name: 'AI Council', url: '/council', description: 'Convene the AI Council' },
      { name: 'Content Calendar', url: '/content', description: 'Manage content' },
      { name: 'Pipeline', url: '/pipeline', description: 'View pipeline' },
    ],
  });
});

// --‚îÄ PWA: Service Worker ----------------------------------------------------‚îÄ
app.get('/service-worker.js', (req, res) => {
  res.setHeader('Content-Type', 'application/javascript');
  res.send(`
const CACHE_NAME = 'mc-v2';
const SHELL_URLS = ['/', '/council', '/growth', '/pipeline', '/content'];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME).then(cache => cache.addAll(SHELL_URLS)).then(() => self.skipWaiting())
  );
});

self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(keys => Promise.all(
      keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))
    )).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', event => {
  const url = new URL(event.request.url);
  // Skip API calls and non-GET requests
  if (event.request.method !== 'GET' || url.pathname.startsWith('/api/')) {
    return;
  }
  event.respondWith(
    fetch(event.request).then(response => {
      const clone = response.clone();
      caches.open(CACHE_NAME).then(cache => cache.put(event.request, clone));
      return response;
    }).catch(() => caches.match(event.request).then(r => r || new Response(
      '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Offline -- Mission Control</title><style>body{font-family:-apple-system,sans-serif;background:#0a0e27;color:#e0e0e0;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;text-align:center}h1{font-size:2rem;background:linear-gradient(135deg,#00d4ff,#7b2ff7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}p{color:#5a6a8a}</style></head><body><div><h1>üì° Offline</h1><p>Mission Control will reconnect when you are back online.</p></div></body></html>',
      { headers: { 'Content-Type': 'text/html' } }
    )))
  );
});
`);
});

// --‚îÄ PWA: Icon Generator ----------------------------------------------------‚îÄ
app.get('/api/icon/:size', (req, res) => {
  const size = parseInt(req.params.size) || 192;
  // Generate a simple SVG icon and convert it to an inline SVG served as image
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
    <defs>
      <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#0a0e27"/>
        <stop offset="100%" stop-color="#1a1f3a"/>
      </linearGradient>
      <linearGradient id="accent" x1="0" y1="0" x2="1" y2="1">
        <stop offset="0%" stop-color="#00d4ff"/>
        <stop offset="100%" stop-color="#7b2ff7"/>
      </linearGradient>
    </defs>
    <rect width="${size}" height="${size}" rx="${size * 0.2}" fill="url(#bg)"/>
    <text x="50%" y="53%" text-anchor="middle" dominant-baseline="central" font-family="Arial,sans-serif" font-weight="800" font-size="${size * 0.35}" fill="url(#accent)">MC</text>
    <rect x="${size * 0.15}" y="${size * 0.78}" width="${size * 0.7}" height="${size * 0.04}" rx="${size * 0.02}" fill="url(#accent)" opacity="0.6"/>
  </svg>`;
  res.setHeader('Content-Type', 'image/svg+xml');
  res.setHeader('Cache-Control', 'public, max-age=86400');
  res.send(svg);
});

// --‚îÄ Market Data API --------------------------------------------------------‚îÄ
app.get('/api/market', async (req, res) => {
  const tickers = [
    { symbol: 'TSLA', name: 'Tesla', icon: '‚ö°' },
    { symbol: 'VAS.AX', name: 'Vanguard Aus', icon: 'üá¶üá∫' },
    { symbol: 'KTOS', name: 'Kratos Defense', icon: 'üõ°Ô∏è' },
    { symbol: 'NVDA', name: 'NVIDIA', icon: 'üü¢' },
    { symbol: 'BTC-USD', name: 'Bitcoin', icon: '‚Çø' },
    { symbol: 'GC=F', name: 'Gold (XAU)', icon: 'ü•á' },
    { symbol: 'SI=F', name: 'Silver (XAG)', icon: 'ü•à' },
  ];

  try {
    const results = await Promise.allSettled(
      tickers.map(async (t) => {
        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(t.symbol)}?range=5d&interval=1h&includePrePost=false`;
        const resp = await fetch(url, {
          headers: { 'User-Agent': 'Mozilla/5.0 (compatible; MissionControl/2.0)' }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        const result = data.chart?.result?.[0];
        if (!result) throw new Error('No data for ' + t.symbol);

        const meta = result.meta;
        const price = meta.regularMarketPrice;
        const prevClose = meta.chartPreviousClose || meta.previousClose || price;
        const change = price - prevClose;
        const changePercent = prevClose > 0 ? (change / prevClose) * 100 : 0;

        const closes = result.indicators?.quote?.[0]?.close || [];
        const sparkline = closes.filter(v => v != null).slice(-30);

        return {
          ...t,
          price,
          change,
          changePercent,
          currency: meta.currency || 'USD',
          sparkline,
        };
      })
    );

    const data = results.map((r, i) => {
      if (r.status === 'fulfilled') return r.value;
      return { ...tickers[i], price: null, error: r.reason?.message || 'Failed' };
    });

    res.setHeader('Cache-Control', 'public, max-age=30');
    res.json({ tickers: data, timestamp: new Date().toISOString() });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// --‚îÄ Content Auto-Generation API --------------------------------------------‚îÄ
app.post('/api/content/generate', async (req, res) => {
  const { niche } = req.body;

  if (!anthropic && !openai) {
    return res.status(500).json({ error: 'No AI API keys configured.' });
  }

  const today = new Date();
  const dateStr = (d) => d.toISOString().split('T')[0];

  const systemPrompt = `You are an expert content strategist. Generate a 30-day content calendar.
Return ONLY valid JSON -- no markdown, no code fences, no explanation. Return an array of objects with these exact keys:
- title: compelling title
- type: one of "linkedin", "youtube", "twitter", "short"
- status: "idea"
- date: ISO date string (YYYY-MM-DD)
- notes: 2-3 sentence draft copy or outline
- tags: comma-separated relevant tags
- postTime: optimal posting time (e.g. "9:00 AM EST")

Mix platforms roughly evenly. Space content across all 30 days. Include a variety of:
- LinkedIn thought leadership posts
- YouTube video concepts
- Twitter/X thread ideas
- Short-form video ideas

Make all content specific, actionable, and tailored to the niche. Vary post times for optimal engagement per platform.`;

  const userPrompt = `Generate a 30-day content calendar starting from ${dateStr(today)} for this niche/topics: ${niche || 'tech, AI, entrepreneurship, content creation'}

Return ONLY the JSON array. No other text.`;

  try {
    let responseText;

    if (anthropic) {
      const resp = await anthropic.messages.create({
        model: MODELS.SONNET,
        max_tokens: 4000,
        temperature: 0.9,
        system: systemPrompt,
        messages: [{ role: 'user', content: userPrompt }],
      });
      responseText = resp.content[0]?.text?.trim() || '';
    } else if (openai) {
      const completion = await openai.chat.completions.create({
        model: MODELS.GPT4O,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt },
        ],
        max_tokens: 4000,
        temperature: 0.9,
      });
      responseText = completion.choices[0]?.message?.content?.trim() || '';
    }

    // Parse JSON from response (strip markdown fences if present)
    let cleaned = responseText.replace(/^```(?:json)?\s*/i, '').replace(/\s*```$/i, '').trim();
    const items = JSON.parse(cleaned);

    if (!Array.isArray(items)) {
      return res.status(500).json({ error: 'AI returned invalid format' });
    }

    // Map to content calendar format
    const mapped = items.map((item, i) => {
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      const typeMap = { linkedin: 'community', youtube: 'video', twitter: 'community', short: 'short' };
      return {
        title: item.title || 'Untitled',
        type: typeMap[item.type] || item.type || 'video',
        status: 'idea',
        date: item.date || dateStr(d),
        notes: (item.notes || '') + (item.postTime ? '\\n‚è∞ Best time: ' + item.postTime : '') + (item.type ? '\\nüì± Platform: ' + item.type : ''),
        tags: item.tags || '',
      };
    });

    res.json({ items: mapped, count: mapped.length });
  } catch (err) {
    console.error('Content generation error:', err.message);
    res.status(500).json({ error: 'Failed to generate content: ' + err.message });
  }
});

// --‚îÄ Memory / Second Brain API -----------------------------------------------
const fs = require('fs');
const path = require('path');
const WORKSPACE = process.env.WORKSPACE_PATH || '/home/luke/.openclaw/workspace';
const MEMORY_DIR = path.join(WORKSPACE, 'memory');
const BRAIN_DIR = path.join(WORKSPACE, 'brain');
const MEMORY_MD = path.join(WORKSPACE, 'MEMORY.md');

function getRelativeDate(dateStr) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const d = new Date(dateStr + 'T00:00:00');
  const diffDays = Math.floor((today - d) / 86400000);
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return diffDays + ' days ago';
  if (diffDays < 14) return 'Last week';
  if (diffDays < 30) return Math.floor(diffDays / 7) + ' weeks ago';
  if (diffDays < 60) return 'Last month';
  return Math.floor(diffDays / 30) + ' months ago';
}

function groupMemoryFiles(files) {
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const groups = { today: [], yesterday: [], thisWeek: [], thisMonth: [], older: {} };

  files.forEach(f => {
    if (!f.date) { return; }
    const d = new Date(f.date + 'T00:00:00');
    const diffDays = Math.floor((today - d) / 86400000);
    if (diffDays === 0) groups.today.push(f);
    else if (diffDays === 1) groups.yesterday.push(f);
    else if (diffDays < 7) groups.thisWeek.push(f);
    else if (diffDays < 30) groups.thisMonth.push(f);
    else {
      const monthKey = f.date.substring(0, 7); // YYYY-MM
      if (!groups.older[monthKey]) groups.older[monthKey] = [];
      groups.older[monthKey].push(f);
    }
  });
  return groups;
}

// GET /api/memory/list
app.get('/api/memory/list', (req, res) => {
  try {
    const results = [];

    // Add MEMORY.md (long-term)
    try {
      const stat = require('fs').statSync(MEMORY_MD);
      results.push({
        filename: 'MEMORY.md',
        type: 'long-term',
        date: null,
        size: stat.size,
        modified: stat.mtime.toISOString(),
        label: 'Long-Term Memory',
      });
    } catch(e) {}

    // Add daily memory files
    try {
      const files = require('fs').readdirSync(MEMORY_DIR);
      files.filter(f => /^\d{4}-\d{2}-\d{2}(-.+)?\.md$/.test(f)).sort().reverse().forEach(f => {
        try {
          const stat = require('fs').statSync(path.join(MEMORY_DIR, f));
          const dateMatch = f.match(/^(\d{4}-\d{2}-\d{2})/);
          results.push({
            filename: f,
            type: 'daily',
            date: dateMatch ? dateMatch[1] : null,
            size: stat.size,
            modified: stat.mtime.toISOString(),
            label: dateMatch ? dateMatch[1] : f,
            relative: dateMatch ? getRelativeDate(dateMatch[1]) : null,
          });
        } catch(e) {}
      });
    } catch(e) {}

    // Add brain documents
    try {
      function scanBrain(dir, prefix) {
        const entries = require('fs').readdirSync(dir, { withFileTypes: true });
        entries.forEach(entry => {
          const fullPath = path.join(dir, entry.name);
          if (entry.isDirectory()) {
            scanBrain(fullPath, prefix + entry.name + '/');
          } else if (entry.name.endsWith('.md')) {
            try {
              const stat = require('fs').statSync(fullPath);
              results.push({
                filename: 'brain/' + prefix + entry.name,
                type: 'brain',
                date: null,
                size: stat.size,
                modified: stat.mtime.toISOString(),
                label: entry.name.replace('.md', ''),
                category: prefix.replace(/\/$/, '') || 'root',
              });
            } catch(e) {}
          }
        });
      }
      scanBrain(BRAIN_DIR, '');
    } catch(e) {}

    const dailyFiles = results.filter(r => r.type === 'daily');
    const groups = groupMemoryFiles(dailyFiles);

    res.json({
      total: results.length,
      files: results,
      groups,
      brainCategories: [...new Set(results.filter(r => r.type === 'brain').map(r => r.category))],
    });
  } catch(err) {
    res.status(500).json({ error: 'Failed to list memory files: ' + err.message });
  }
});

// GET /api/memory/read/:filename
app.get('/api/memory/read/:filename(*)', (req, res) => {
  try {
    let filePath;
    const fn = req.params.filename;

    if (fn === 'MEMORY.md') {
      filePath = MEMORY_MD;
    } else if (fn.startsWith('brain/')) {
      filePath = path.join(BRAIN_DIR, fn.replace('brain/', ''));
    } else {
      filePath = path.join(MEMORY_DIR, fn);
    }

    // Security: prevent path traversal
    const resolved = path.resolve(filePath);
    if (!resolved.startsWith(path.resolve(WORKSPACE))) {
      return res.status(403).json({ error: 'Access denied' });
    }

    if (!require('fs').existsSync(resolved)) {
      return res.status(404).json({ error: 'File not found' });
    }

    const content = require('fs').readFileSync(resolved, 'utf-8');
    const stat = require('fs').statSync(resolved);

    res.json({
      filename: fn,
      content,
      size: stat.size,
      modified: stat.mtime.toISOString(),
    });
  } catch(err) {
    res.status(500).json({ error: 'Failed to read memory file: ' + err.message });
  }
});

// POST /api/memory/add
app.post('/api/memory/add', (req, res) => {
  try {
    const { content, category } = req.body;
    if (!content) {
      return res.status(400).json({ error: 'content is required' });
    }

    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const mins = String(now.getMinutes()).padStart(2, '0');

    if (category === 'long-term') {
      // Append to MEMORY.md
      const entry = '\n\n---\n\n## ' + hours + ':' + mins + ' -- Added Memory\n\n' + content + '\n';
      if (!require('fs').existsSync(MEMORY_MD)) {
        require('fs').writeFileSync(MEMORY_MD, '# Long-Term Memory\n' + entry, 'utf-8');
      } else {
        require('fs').appendFileSync(MEMORY_MD, entry, 'utf-8');
      }
      res.json({ success: true, saved: 'MEMORY.md', timestamp: hours + ':' + mins });
    } else {
      // Append to today's daily file
      const dateStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
      const dailyFile = path.join(MEMORY_DIR, dateStr + '.md');
      const entry = '\n## ' + hours + ':' + mins + ' -- Memory\n\n' + content + '\n\n---\n';

      // Ensure memory dir exists
      if (!require('fs').existsSync(MEMORY_DIR)) {
        require('fs').mkdirSync(MEMORY_DIR, { recursive: true });
      }

      if (!require('fs').existsSync(dailyFile)) {
        require('fs').writeFileSync(dailyFile, '# ' + dateStr + ' Daily Log\n' + entry, 'utf-8');
      } else {
        require('fs').appendFileSync(dailyFile, entry, 'utf-8');
      }
      res.json({ success: true, saved: dateStr + '.md', timestamp: hours + ':' + mins });
    }
  } catch(err) {
    res.status(500).json({ error: 'Failed to add memory: ' + err.message });
  }
});

// GET /api/memory/search?q=keyword
app.get('/api/memory/search', (req, res) => {
  try {
    const query = (req.query.q || '').toLowerCase().trim();
    if (!query) {
      return res.status(400).json({ error: 'q parameter is required' });
    }

    const results = [];

    function searchFile(filePath, filename, type) {
      try {
        const content = require('fs').readFileSync(filePath, 'utf-8');
        const lines = content.split('\n');
        lines.forEach((line, idx) => {
          if (line.toLowerCase().includes(query)) {
            const contextStart = Math.max(0, idx - 1);
            const contextEnd = Math.min(lines.length, idx + 2);
            results.push({
              filename,
              type,
              line: idx + 1,
              text: line.trim(),
              context: lines.slice(contextStart, contextEnd).join('\n'),
            });
          }
        });
      } catch(e) {}
    }

    // Search MEMORY.md
    searchFile(MEMORY_MD, 'MEMORY.md', 'long-term');

    // Search daily files
    try {
      require('fs').readdirSync(MEMORY_DIR).filter(f => f.endsWith('.md')).forEach(f => {
        searchFile(path.join(MEMORY_DIR, f), f, 'daily');
      });
    } catch(e) {}

    // Search brain files
    function searchBrain(dir, prefix) {
      try {
        require('fs').readdirSync(dir, { withFileTypes: true }).forEach(entry => {
          const fullPath = path.join(dir, entry.name);
          if (entry.isDirectory()) {
            searchBrain(fullPath, prefix + entry.name + '/');
          } else if (entry.name.endsWith('.md')) {
            searchFile(fullPath, 'brain/' + prefix + entry.name, 'brain');
          }
        });
      } catch(e) {}
    }
    searchBrain(BRAIN_DIR, '');

    res.json({
      query,
      total: results.length,
      results: results.slice(0, 100), // cap at 100 results
    });
  } catch(err) {
    res.status(500).json({ error: 'Search failed: ' + err.message });
  }
});

// --‚îÄ Memory Page (Second Brain UI) ------------------------------------------‚îÄ
app.get('/memory', (req, res) => {
  res.send(`<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Second Brain -- Mission Control</title>
    ${NAV_STYLE}
    <style>
      /* Memory Layout */
      .memory-layout {
        display: grid;
        grid-template-columns: 280px 1fr 260px;
        gap: 1.5rem;
        min-height: calc(100vh - 80px);
        padding: 1.5rem 2rem;
        max-width: 1600px;
        margin: 0 auto;
      }
      @media (max-width: 1100px) {
        .memory-layout { grid-template-columns: 240px 1fr; }
        .memory-right { display: none; }
      }
      @media (max-width: 768px) {
        .memory-layout { grid-template-columns: 1fr; }
        .memory-sidebar { display: none; }
        .mobile-toggle { display: flex !important; }
      }

      /* Sidebar */
      .memory-sidebar {
        background: rgba(12, 16, 38, 0.65);
        backdrop-filter: blur(24px);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 16px;
        padding: 1.25rem;
        overflow-y: auto;
        max-height: calc(100vh - 110px);
        position: sticky; top: 80px;
      }
      .sidebar-title {
        font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 1.5px; color: #3a4a6a; margin-bottom: 0.75rem;
        padding: 0 0.5rem;
      }
      .memory-item {
        display: flex; align-items: center; gap: 0.6rem;
        padding: 0.55rem 0.75rem; border-radius: 10px;
        cursor: pointer; transition: all 0.2s;
        font-size: 0.82rem; color: #7a8aaa;
        margin-bottom: 2px;
      }
      .memory-item:hover { background: rgba(255,255,255,0.04); color: #b0c4de; }
      .memory-item.active { background: rgba(0, 212, 255, 0.1); color: #00d4ff; }
      .memory-item .icon { font-size: 0.9rem; flex-shrink: 0; width: 20px; text-align: center; }
      .memory-item .label { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .memory-item .meta { font-size: 0.65rem; color: #3a4a6a; flex-shrink: 0; }

      .memory-item.long-term { color: #f9ca24; }
      .memory-item.long-term:hover { background: rgba(249, 202, 36, 0.08); }
      .memory-item.long-term.active { background: rgba(249, 202, 36, 0.15); color: #f9ca24; }

      .memory-item.brain-item { color: #a29bfe; }
      .memory-item.brain-item:hover { background: rgba(162, 155, 254, 0.08); }
      .memory-item.brain-item.active { background: rgba(162, 155, 254, 0.12); color: #a29bfe; }

      .group-header {
        font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 1px; color: #2a3a5a; margin: 0.75rem 0 0.35rem 0.5rem;
        display: flex; align-items: center; gap: 0.5rem; cursor: pointer;
        user-select: none;
      }
      .group-header:hover { color: #4a5a7a; }
      .group-header .chevron {
        font-size: 0.55rem; transition: transform 0.2s;
        display: inline-block;
      }
      .group-header.collapsed .chevron { transform: rotate(-90deg); }
      .group-content { overflow: hidden; transition: max-height 0.3s ease; }
      .group-content.collapsed { max-height: 0 !important; overflow: hidden; }

      .sidebar-divider {
        height: 1px; background: rgba(255,255,255,0.04);
        margin: 0.75rem 0;
      }

      /* Main Content Panel */
      .memory-main {
        background: rgba(12, 16, 38, 0.45);
        backdrop-filter: blur(24px);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 16px;
        padding: 2rem;
        overflow-y: auto;
        max-height: calc(100vh - 110px);
        position: relative;
      }
      .memory-main .doc-header {
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 1.5rem; padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.06);
      }
      .doc-title {
        font-size: 1.4rem; font-weight: 700; color: #c0d0e8;
        display: flex; align-items: center; gap: 0.75rem;
      }
      .doc-title .type-badge {
        font-size: 0.6rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 0.5px; padding: 0.2rem 0.6rem; border-radius: 50px;
      }
      .badge-daily { background: rgba(0, 212, 255, 0.15); color: #00d4ff; }
      .badge-long-term { background: rgba(249, 202, 36, 0.15); color: #f9ca24; }
      .badge-brain { background: rgba(162, 155, 254, 0.15); color: #a29bfe; }

      .doc-meta { font-size: 0.75rem; color: #4a5a7a; }

      /* Markdown Rendering */
      .md-content { line-height: 1.75; color: #b0c4de; animation: fadeInContent 0.3s ease; }
      .md-content h1 { font-size: 1.6rem; font-weight: 800; color: #e0e8f0; margin: 1.5rem 0 0.75rem 0; background: linear-gradient(135deg, #00d4ff, #7b2ff7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
      .md-content h2 { font-size: 1.2rem; font-weight: 700; color: #c0d0e8; margin: 1.25rem 0 0.5rem 0; padding-bottom: 0.4rem; border-bottom: 1px solid rgba(255,255,255,0.06); }
      .md-content h3 { font-size: 1rem; font-weight: 600; color: #a0b8d0; margin: 1rem 0 0.4rem 0; }
      .md-content p { margin: 0.5rem 0; }
      .md-content ul, .md-content ol { padding-left: 1.5rem; margin: 0.5rem 0; }
      .md-content li { margin: 0.25rem 0; }
      .md-content strong { color: #d0e0f0; font-weight: 700; }
      .md-content em { color: #8b9dc3; font-style: italic; }
      .md-content code { background: rgba(0, 212, 255, 0.08); padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.85em; font-family: 'JetBrains Mono', monospace; color: #00d4ff; }
      .md-content pre { background: rgba(8, 10, 25, 0.8); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 1rem; overflow-x: auto; margin: 0.75rem 0; }
      .md-content pre code { background: none; padding: 0; color: #b0c4de; }
      .md-content blockquote { border-left: 3px solid rgba(0, 212, 255, 0.4); padding-left: 1rem; margin: 0.75rem 0; color: #7a8aaa; font-style: italic; }
      .md-content hr { border: none; border-top: 1px solid rgba(255,255,255,0.06); margin: 1.25rem 0; }
      .md-content a { color: #00d4ff; text-decoration: none; }
      .md-content a:hover { text-decoration: underline; }
      .md-content table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; }
      .md-content th, .md-content td { padding: 0.5rem 0.75rem; border: 1px solid rgba(255,255,255,0.08); text-align: left; }
      .md-content th { background: rgba(255,255,255,0.04); font-weight: 600; color: #c0d0e8; }

      @keyframes fadeInContent { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

      /* Empty State */
      .empty-state {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 60%; text-align: center; color: #3a4a6a;
      }
      .empty-state .big-icon { font-size: 4rem; margin-bottom: 1rem; opacity: 0.5; }
      .empty-state h2 { font-size: 1.3rem; font-weight: 700; color: #5a6a8a; margin-bottom: 0.5rem; }
      .empty-state p { font-size: 0.85rem; max-width: 320px; line-height: 1.6; }

      /* Right Panel */
      .memory-right {
        display: flex; flex-direction: column; gap: 1rem;
        position: sticky; top: 80px;
        max-height: calc(100vh - 110px);
      }
      .right-card {
        background: rgba(12, 16, 38, 0.65);
        backdrop-filter: blur(24px);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 16px;
        padding: 1.25rem;
      }
      .right-card h3 {
        font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 1.5px; color: #3a4a6a; margin-bottom: 0.75rem;
      }

      /* Search */
      .search-box {
        width: 100%; padding: 0.6rem 0.85rem 0.6rem 2.2rem;
        background: rgba(8, 10, 25, 0.6);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px; color: #c0d0e8;
        font-size: 0.82rem; font-family: inherit;
        outline: none; transition: all 0.3s;
      }
      .search-box:focus { border-color: rgba(0, 212, 255, 0.3); box-shadow: 0 0 20px rgba(0, 212, 255, 0.05); }
      .search-box::placeholder { color: #3a4a6a; }
      .search-wrapper { position: relative; }
      .search-icon { position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); font-size: 0.8rem; color: #3a4a6a; pointer-events: none; }

      .search-results { margin-top: 0.5rem; }
      .search-result {
        padding: 0.6rem 0.75rem; border-radius: 8px;
        cursor: pointer; transition: all 0.2s;
        margin-bottom: 4px; border-left: 3px solid transparent;
      }
      .search-result:hover { background: rgba(255,255,255,0.04); }
      .search-result .sr-file { font-size: 0.7rem; color: #5a6a8a; font-weight: 600; }
      .search-result .sr-text { font-size: 0.78rem; color: #8b9dc3; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .search-result .sr-text mark { background: rgba(249, 202, 36, 0.3); color: #f9ca24; padding: 0 2px; border-radius: 2px; }
      .search-result.sr-daily { border-left-color: #00d4ff; }
      .search-result.sr-long-term { border-left-color: #f9ca24; }
      .search-result.sr-brain { border-left-color: #a29bfe; }

      /* Add Memory */
      .add-memory-btn {
        width: 100%; padding: 0.7rem;
        background: linear-gradient(135deg, #00d4ff 0%, #7b2ff7 100%);
        color: white; border: none; border-radius: 10px;
        font-weight: 600; font-size: 0.82rem; font-family: inherit;
        cursor: pointer; transition: all 0.3s;
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      }
      .add-memory-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3); }

      .add-form { display: none; margin-top: 0.75rem; }
      .add-form.active { display: block; }
      .add-textarea {
        width: 100%; min-height: 80px; padding: 0.7rem;
        background: rgba(8, 10, 25, 0.6);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 10px; color: #c0d0e8;
        font-size: 0.82rem; font-family: inherit;
        outline: none; resize: vertical; transition: border-color 0.3s;
      }
      .add-textarea:focus { border-color: rgba(0, 212, 255, 0.3); }
      .add-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
      .add-actions select {
        flex: 1; padding: 0.5rem; background: rgba(8, 10, 25, 0.6);
        border: 1px solid rgba(255,255,255,0.08); border-radius: 8px;
        color: #c0d0e8; font-size: 0.78rem; font-family: inherit;
        outline: none;
      }
      .add-actions button {
        padding: 0.5rem 1rem; border-radius: 8px; border: none;
        font-weight: 600; font-size: 0.78rem; cursor: pointer;
        font-family: inherit; transition: all 0.2s;
      }
      .btn-save { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
      .btn-save:hover { background: rgba(46, 213, 115, 0.3); }
      .btn-cancel { background: rgba(255,255,255,0.05); color: #5a6a8a; }
      .btn-cancel:hover { background: rgba(255,255,255,0.08); }

      /* Stats */
      .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 0.35rem 0; }
      .stat-label { font-size: 0.78rem; color: #5a6a8a; }
      .stat-value { font-size: 0.82rem; font-weight: 600; color: #c0d0e8; }

      /* Mobile toggle */
      .mobile-toggle {
        display: none; position: fixed; bottom: 1.5rem; right: 1.5rem;
        width: 48px; height: 48px; border-radius: 50%;
        background: linear-gradient(135deg, #00d4ff, #7b2ff7);
        border: none; color: white; font-size: 1.3rem;
        cursor: pointer; z-index: 90; box-shadow: 0 4px 20px rgba(0,212,255,0.3);
        align-items: center; justify-content: center;
      }

      /* Loading spinner */
      .loading-spinner {
        display: flex; align-items: center; justify-content: center;
        height: 200px; color: #3a4a6a;
      }
      .loading-spinner::after {
        content: ''; width: 32px; height: 32px; border: 3px solid rgba(0,212,255,0.2);
        border-top-color: #00d4ff; border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

      /* Toast */
      .toast {
        position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px);
        background: rgba(12, 16, 38, 0.95); backdrop-filter: blur(20px);
        border: 1px solid rgba(46, 213, 115, 0.3);
        color: #2ed573; padding: 0.75rem 1.5rem; border-radius: 12px;
        font-size: 0.85rem; font-weight: 600; z-index: 200;
        transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: none;
      }
      .toast.show { transform: translateX(-50%) translateY(0); }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  </head><body>
    ${NAV_HTML}

    <div class="memory-layout">
      <!-- Left Sidebar: File List -->
      <div class="memory-sidebar" id="memorySidebar">
        <div class="sidebar-title">üß† Second Brain</div>
        <div id="sidebarContent"><div class="loading-spinner"></div></div>
      </div>

      <!-- Center: Document Viewer -->
      <div class="memory-main" id="memoryMain">
        <div class="empty-state" id="emptyState">
          <div class="big-icon">üß†</div>
          <h2>Second Brain</h2>
          <p>Select a memory from the sidebar, or search across all your notes and journals.</p>
        </div>
        <div id="docView" style="display:none">
          <div class="doc-header">
            <div>
              <div class="doc-title" id="docTitle"></div>
              <div class="doc-meta" id="docMeta"></div>
            </div>
          </div>
          <div class="md-content" id="docContent"></div>
        </div>
      </div>

      <!-- Right Panel: Actions -->
      <div class="memory-right">
        <div class="right-card">
          <h3>‚ú® Quick Add</h3>
          <button class="add-memory-btn" onclick="toggleAddForm()">
            <span>+</span> Add Memory
          </button>
          <div class="add-form" id="addForm">
            <textarea class="add-textarea" id="addContent" placeholder="What do you want to remember?"></textarea>
            <div class="add-actions">
              <select id="addCategory">
                <option value="daily">üìÖ Today's Journal</option>
                <option value="long-term">‚≠ê Long-Term</option>
              </select>
              <button class="btn-save" onclick="saveMemory()">Save</button>
              <button class="btn-cancel" onclick="toggleAddForm()">Cancel</button>
            </div>
          </div>
        </div>

        <div class="right-card">
          <h3>üîç Search</h3>
          <div class="search-wrapper">
            <span class="search-icon">üîé</span>
            <input type="text" class="search-box" id="searchBox" placeholder="Search all memories..." oninput="debounceSearch()">
          </div>
          <div class="search-results" id="searchResults"></div>
        </div>

        <div class="right-card" id="statsCard">
          <h3>üìä Stats</h3>
          <div id="statsContent"></div>
        </div>
      </div>
    </div>

    <button class="mobile-toggle" onclick="document.getElementById('memorySidebar').classList.toggle('mobile-show')">‚ò∞</button>
    <div class="toast" id="toast"></div>

    <script>
      document.getElementById('nav-memory').classList.add('active');

      var currentFile = null;
      var memoryData = null;
      var searchTimer = null;

      // -- Load sidebar --
      function loadSidebar() {
        fetch('/api/memory/list').then(function(r){return r.json()}).then(function(data){
          memoryData = data;
          renderSidebar(data);
          renderStats(data);
        }).catch(function(err){
          document.getElementById('sidebarContent').innerHTML = '<div style="color:#ff4757;padding:1rem;font-size:0.82rem">Failed to load memories</div>';
        });
      }

      function renderSidebar(data) {
        var html = '';

        // Long-Term Memory
        var ltm = data.files.find(function(f){return f.filename === 'MEMORY.md'});
        if (ltm) {
          html += '<div class="memory-item long-term" onclick="loadFile(\\'MEMORY.md\\')" data-file="MEMORY.md">';
          html += '<span class="icon">‚≠ê</span><span class="label">Long-Term Memory</span>';
          html += '<span class="meta">' + formatSize(ltm.size) + '</span></div>';
          html += '<div class="sidebar-divider"></div>';
        }

        // Today
        if (data.groups.today.length) {
          html += '<div class="sidebar-title" style="margin-top:0">üìÖ Today</div>';
          data.groups.today.forEach(function(f){
            html += renderSidebarItem(f);
          });
        }

        // Yesterday
        if (data.groups.yesterday.length) {
          html += '<div class="group-header" onclick="toggleGroup(this)"><span class="chevron">‚ñº</span> Yesterday</div>';
          html += '<div class="group-content">';
          data.groups.yesterday.forEach(function(f){ html += renderSidebarItem(f); });
          html += '</div>';
        }

        // This Week
        if (data.groups.thisWeek.length) {
          html += '<div class="group-header" onclick="toggleGroup(this)"><span class="chevron">‚ñº</span> This Week</div>';
          html += '<div class="group-content">';
          data.groups.thisWeek.forEach(function(f){ html += renderSidebarItem(f); });
          html += '</div>';
        }

        // This Month
        if (data.groups.thisMonth.length) {
          html += '<div class="group-header collapsed" onclick="toggleGroup(this)"><span class="chevron">‚ñº</span> This Month</div>';
          html += '<div class="group-content collapsed">';
          data.groups.thisMonth.forEach(function(f){ html += renderSidebarItem(f); });
          html += '</div>';
        }

        // Older months
        var olderKeys = Object.keys(data.groups.older).sort().reverse();
        olderKeys.forEach(function(monthKey) {
          var monthLabel = formatMonthKey(monthKey);
          html += '<div class="group-header collapsed" onclick="toggleGroup(this)"><span class="chevron">‚ñº</span> ' + monthLabel + '</div>';
          html += '<div class="group-content collapsed">';
          data.groups.older[monthKey].forEach(function(f){ html += renderSidebarItem(f); });
          html += '</div>';
        });

        // Brain documents
        var brainFiles = data.files.filter(function(f){return f.type === 'brain'});
        if (brainFiles.length) {
          html += '<div class="sidebar-divider"></div>';
          html += '<div class="sidebar-title">üß¨ Brain Docs</div>';

          var categories = {};
          brainFiles.forEach(function(f){
            var cat = f.category || 'root';
            if (!categories[cat]) categories[cat] = [];
            categories[cat].push(f);
          });

          Object.keys(categories).sort().forEach(function(cat) {
            if (cat !== 'root') {
              html += '<div class="group-header collapsed" onclick="toggleGroup(this)"><span class="chevron">‚ñº</span> ' + cat + '</div>';
              html += '<div class="group-content collapsed">';
            }
            categories[cat].forEach(function(f){
              html += '<div class="memory-item brain-item" onclick="loadFile(\\'' + escapeJs(f.filename) + '\\')" data-file="' + escapeHtml(f.filename) + '">';
              html += '<span class="icon">üìÑ</span><span class="label">' + escapeHtml(f.label) + '</span>';
              html += '<span class="meta">' + formatSize(f.size) + '</span></div>';
            });
            if (cat !== 'root') {
              html += '</div>';
            }
          });
        }

        document.getElementById('sidebarContent').innerHTML = html;

        // Auto-select today if available
        if (data.groups.today.length && !currentFile) {
          loadFile(data.groups.today[0].filename);
        }
      }

      function renderSidebarItem(f) {
        return '<div class="memory-item" onclick="loadFile(\\'' + escapeJs(f.filename) + '\\')" data-file="' + escapeHtml(f.filename) + '">' +
          '<span class="icon">üìù</span>' +
          '<span class="label">' + escapeHtml(f.date || f.filename) + '</span>' +
          '<span class="meta">' + (f.relative || '') + '</span></div>';
      }

      // -- Load file --
      function loadFile(filename) {
        currentFile = filename;

        // Update active state
        document.querySelectorAll('.memory-item').forEach(function(el){
          el.classList.toggle('active', el.getAttribute('data-file') === filename);
        });

        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('docView').style.display = 'block';
        document.getElementById('docContent').innerHTML = '<div class="loading-spinner"></div>';

        // Set title
        var titleText = filename;
        var badgeClass = 'badge-daily';
        var badgeText = 'Daily';
        if (filename === 'MEMORY.md') {
          titleText = '‚≠ê Long-Term Memory';
          badgeClass = 'badge-long-term';
          badgeText = 'Long-Term';
        } else if (filename.startsWith('brain/')) {
          titleText = 'üß¨ ' + filename.replace('brain/', '').replace('.md', '');
          badgeClass = 'badge-brain';
          badgeText = 'Brain';
        } else {
          titleText = 'üìù ' + filename.replace('.md', '');
        }
        document.getElementById('docTitle').innerHTML = escapeHtml(titleText) + ' <span class="type-badge ' + badgeClass + '">' + badgeText + '</span>';

        fetch('/api/memory/read/' + encodeURIComponent(filename)).then(function(r){return r.json()}).then(function(data){
          if (data.error) {
            document.getElementById('docContent').innerHTML = '<div style="color:#ff4757;padding:1rem">Error: ' + escapeHtml(data.error) + '</div>';
            return;
          }
          document.getElementById('docMeta').textContent = 'Modified: ' + new Date(data.modified).toLocaleString() + ' -- ' + formatSize(data.size);
          document.getElementById('docContent').innerHTML = renderMarkdown(data.content);
        }).catch(function(){
          document.getElementById('docContent').innerHTML = '<div style="color:#ff4757;padding:1rem">Failed to load file</div>';
        });
      }

      // -- Simple Markdown Renderer --
      function renderMarkdown(text) {
        if (!text) return '<p style="color:#5a6a8a">Empty file</p>';

        // Escape HTML first
        var html = text
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');

        // Code blocks
        var BT = String.fromCharCode(96);
        var cbRegex = new RegExp(BT+BT+BT+'(\\\\w*)?\\\\n([\\\\s\\\\S]*?)'+BT+BT+BT, 'g');
        html = html.replace(cbRegex, function(m, lang, code) {
          return '<pre><code class="lang-' + (lang||'') + '">' + code.trim() + '</code></pre>';
        });

        // Inline code
        var icRegex = new RegExp(BT+'([^'+BT+']+)'+BT, 'g');
        html = html.replace(icRegex, '<code>$1</code>');

        // Headers
        html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

        // Bold and italic
        html = html.replace(/[*][*][*](.+?)[*][*][*]/g, '<strong><em>$1</em></strong>');
        html = html.replace(/[*][*](.+?)[*][*]/g, '<strong>$1</strong>');
        html = html.replace(/[*](.+?)[*]/g, '<em>$1</em>');

        // Links
        html = html.replace(/\\[([^\\]]+)\\]\\(([^)]+)\\)/g, '<a href="$2" target="_blank">$1</a>');

        // Horizontal rules
        html = html.replace(/^---+$/gm, '<hr>');

        // Blockquotes
        html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');

        // Lists (unordered)
        html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
        html = html.replace(new RegExp('(<li>.*</li>)', 'gs'), '<ul>$1</ul>');
        // Clean up nested ul tags
        html = html.replace(new RegExp('</ul>' + '\\\\s*' + '<ul>', 'g'), '');

        // Tables
        html = html.replace(new RegExp('^[|](.+)[|]$', 'gm'), function(m, row) {
          var cells = row.split('|').map(function(c){ return c.trim(); });
          if (cells.every(function(c){ return /^[-:]+$/.test(c); })) return '';
          var tag = 'td';
          return '<tr>' + cells.map(function(c){ return '<' + tag + '>' + c + '</' + tag + '>'; }).join('') + '</tr>';
        });
        html = html.replace(new RegExp('(<tr>.*</tr>\\\\s*)+', 'gs'), function(m) {
          return '<table>' + m + '</table>';
        });

        // Paragraphs (double newline)
        html = html.replace(new RegExp('\\\\n\\\\n+', 'g'), '</p><p>');
        html = '<p>' + html + '</p>';

        // Clean up empty paragraphs
        html = html.replace(new RegExp('<p>\\\\s*</p>', 'g'), '');
        html = html.replace(new RegExp('<p>\\\\s*(<h[1-6]|<pre|<ul|<ol|<hr|<blockquote|<table)', 'g'), '$1');
        html = html.replace(new RegExp('(</h[1-6]>|</pre>|</ul>|</ol>|<hr>|</blockquote>|</table>)\\\\s*</p>', 'g'), '$1');

        return html;
      }

      // -- Search --
      function debounceSearch() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(doSearch, 300);
      }

      function doSearch() {
        var q = document.getElementById('searchBox').value.trim();
        if (!q || q.length < 2) {
          document.getElementById('searchResults').innerHTML = '';
          return;
        }

        fetch('/api/memory/search?q=' + encodeURIComponent(q)).then(function(r){return r.json()}).then(function(data){
          if (!data.results || !data.results.length) {
            document.getElementById('searchResults').innerHTML = '<div style="color:#3a4a6a;font-size:0.78rem;padding:0.5rem">No results found</div>';
            return;
          }

          var html = '<div style="color:#5a6a8a;font-size:0.65rem;margin-bottom:0.5rem;font-weight:600">' + data.total + ' result' + (data.total !== 1 ? 's' : '') + '</div>';
          data.results.slice(0, 20).forEach(function(r) {
            var typeClass = 'sr-' + r.type.replace('-', '');
            var highlighted = escapeHtml(r.text).replace(new RegExp('(' + escapeRegex(q) + ')', 'gi'), '<mark>$1</mark>');
            html += '<div class="search-result ' + typeClass + '" onclick="loadFile(\\'' + escapeJs(r.filename) + '\\')">';
            html += '<div class="sr-file">' + escapeHtml(r.filename) + ' : ' + r.line + '</div>';
            html += '<div class="sr-text">' + highlighted + '</div>';
            html += '</div>';
          });
          document.getElementById('searchResults').innerHTML = html;
        }).catch(function(){
          document.getElementById('searchResults').innerHTML = '<div style="color:#ff4757;font-size:0.78rem;padding:0.5rem">Search failed</div>';
        });
      }

      // -- Add Memory --
      function toggleAddForm() {
        document.getElementById('addForm').classList.toggle('active');
        if (document.getElementById('addForm').classList.contains('active')) {
          document.getElementById('addContent').focus();
        }
      }

      function saveMemory() {
        var content = document.getElementById('addContent').value.trim();
        var category = document.getElementById('addCategory').value;
        if (!content) return;

        fetch('/api/memory/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: content, category: category }),
        }).then(function(r){return r.json()}).then(function(data){
          if (data.success) {
            showToast('‚úÖ Saved to ' + data.saved);
            document.getElementById('addContent').value = '';
            document.getElementById('addForm').classList.remove('active');
            loadSidebar(); // Refresh
            if (data.saved) loadFile(data.saved); // Show the updated file
          } else {
            showToast('‚ùå ' + (data.error || 'Failed to save'));
          }
        }).catch(function(){
          showToast('‚ùå Failed to save memory');
        });
      }

      // -- Stats --
      function renderStats(data) {
        var dailyCount = data.files.filter(function(f){return f.type === 'daily'}).length;
        var brainCount = data.files.filter(function(f){return f.type === 'brain'}).length;
        var totalSize = data.files.reduce(function(a, f){return a + (f.size || 0)}, 0);
        var hasLtm = data.files.some(function(f){return f.type === 'long-term'});

        var html = '';
        html += '<div class="stat-row"><span class="stat-label">Daily Journals</span><span class="stat-value">' + dailyCount + '</span></div>';
        html += '<div class="stat-row"><span class="stat-label">Brain Docs</span><span class="stat-value">' + brainCount + '</span></div>';
        if (hasLtm) html += '<div class="stat-row"><span class="stat-label">Long-Term Memory</span><span class="stat-value" style="color:#f9ca24">Active</span></div>';
        html += '<div class="stat-row"><span class="stat-label">Total Size</span><span class="stat-value">' + formatSize(totalSize) + '</span></div>';
        document.getElementById('statsContent').innerHTML = html;
      }

      // -- Helpers --
      function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / 1048576).toFixed(1) + ' MB';
      }

      function formatMonthKey(key) {
        var parts = key.split('-');
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return months[parseInt(parts[1]) - 1] + ' ' + parts[0];
      }

      function escapeHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      }

      function escapeJs(s) {
        return String(s).split("\\\\").join("\\\\\\\\").split("'").join("\\\\'");
      }

      function escapeRegex(s) {
        var specials = '.\\\\*+?^$' + '{}()|[]-';
        var out = '';
        for (var i = 0; i < s.length; i++) {
          if (specials.indexOf(s[i]) !== -1) out += '\\\\';
          out += s[i];
        }
        return out;
      }

      function showToast(msg) {
        var el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(function(){ el.classList.remove('show'); }, 3000);
      }

      function toggleGroup(el) {
        el.classList.toggle('collapsed');
        var content = el.nextElementSibling;
        if (content) content.classList.toggle('collapsed');
      }

      // -- Init --
      loadSidebar();
      // Refresh every 30s for real-time updates
      setInterval(function() {
        fetch('/api/memory/list').then(function(r){return r.json()}).then(function(data){
          memoryData = data;
          renderStats(data);
          // Only re-render sidebar if file count changed
          var sidebarItems = document.querySelectorAll('.memory-item');
          if (sidebarItems.length !== data.files.length) {
            renderSidebar(data);
          }
        }).catch(function(){});
      }, 30000);
    </script>
  </body></html>`);
});

// --‚îÄ Health Check ------------------------------------------------------------
app.get('/health', (req, res) => res.json({
  status: 'ok',
  agents: ALL_AGENTS.length,
  providers: {
    anthropic: !!anthropic,
    openai: !!openai,
  },
  models: ALL_AGENTS.map(a => ({ id: a.id, model: a.modelLabel, provider: a.provider })),
}));

app.listen(port, () => {
  console.log(`Mission Control running on port ${port}`);
  console.log(`Council: ${COUNCIL_AGENTS.length} agents + Jarvis (Chief of Staff)`);
  console.log(`Providers: Anthropic=${!!anthropic}, OpenAI=${!!openai}`);
});

module.exports = app;

// --‚îÄ Content Items Backend (JSON file-backed CRUD) --------------------------‚îÄ
// fs and path already required above (Memory API section)
const CONTENT_FILE = path.join(__dirname, 'content-items.json');

// In-memory store, loaded from file on startup
let contentItems = [];

function loadContentItems() {
  try {
    if (fs.existsSync(CONTENT_FILE)) {
      const raw = fs.readFileSync(CONTENT_FILE, 'utf-8');
      contentItems = JSON.parse(raw);
      if (!Array.isArray(contentItems)) contentItems = [];
      console.log(`Loaded ${contentItems.length} content items from ${CONTENT_FILE}`);
    } else {
      contentItems = [];
      saveContentItems();
      console.log('Created empty content-items.json');
    }
  } catch (err) {
    console.error('Failed to load content-items.json:', err.message);
    contentItems = [];
  }
}

function saveContentItems() {
  try {
    fs.writeFileSync(CONTENT_FILE, JSON.stringify(contentItems, null, 2), 'utf-8');
  } catch (err) {
    console.error('Failed to save content-items.json:', err.message);
  }
}

// Load on startup
loadContentItems();

function genContentId() {
  return 'c' + Date.now() + Math.random().toString(36).substr(2, 5);
}

// GET /api/content/items -- Return all content items
app.get('/api/content/items', (req, res) => {
  res.json(contentItems);
});

// POST /api/content/items -- Add a new content item
app.post('/api/content/items', (req, res) => {
  const { title, type, status, date, notes, tags, url } = req.body;
  if (!title) {
    return res.status(400).json({ error: 'title is required' });
  }

  const newItem = {
    id: req.body.id || genContentId(),
    title,
    type: type || 'video',
    status: status || 'idea',
    date: date || new Date().toISOString().split('T')[0],
    notes: notes || '',
    tags: tags || '',
    url: url || '',
    created: req.body.created || Date.now(),
  };

  contentItems.push(newItem);
  saveContentItems();
  res.status(201).json(newItem);
});

// PUT /api/content/items/:id -- Update an existing item
app.put('/api/content/items/:id', (req, res) => {
  const idx = contentItems.findIndex(i => i.id === req.params.id);
  if (idx === -1) {
    return res.status(404).json({ error: 'Item not found' });
  }

  const allowed = ['title', 'type', 'status', 'date', 'notes', 'tags', 'url'];
  allowed.forEach(key => {
    if (req.body[key] !== undefined) {
      contentItems[idx][key] = req.body[key];
    }
  });

  saveContentItems();
  res.json(contentItems[idx]);
});

// DELETE /api/content/items/:id -- Delete an item
app.delete('/api/content/items/:id', (req, res) => {
  const idx = contentItems.findIndex(i => i.id === req.params.id);
  if (idx === -1) {
    return res.status(404).json({ error: 'Item not found' });
  }

  const removed = contentItems.splice(idx, 1)[0];
  saveContentItems();
  res.json({ success: true, deleted: removed });
});

// POST /api/content/items/bulk -- Bulk import (merge, avoiding duplicate IDs)
app.post('/api/content/items/bulk', (req, res) => {
  const incoming = req.body;
  if (!Array.isArray(incoming)) {
    return res.status(400).json({ error: 'Expected array of items' });
  }

  const existingIds = new Set(contentItems.map(i => i.id));
  let added = 0;

  incoming.forEach(item => {
    if (!item.title) return;
    if (!item.id) item.id = genContentId();
    if (!existingIds.has(item.id)) {
      item.created = item.created || Date.now();
      contentItems.push(item);
      existingIds.add(item.id);
      added++;
    }
  });

  saveContentItems();
  res.json({ success: true, added, total: contentItems.length });
});

// ============================================================
// KANBAN / TASKS API
// ============================================================

const TASKS_FILE = path.join(__dirname, 'data', 'tasks.json');

function loadTasks() {
  try {
    if (fs.existsSync(TASKS_FILE)) {
      const raw = fs.readFileSync(TASKS_FILE, 'utf8');
      return JSON.parse(raw);
    }
  } catch (err) {
    console.error('Error loading tasks:', err);
  }
  return [];
}

function saveTasks(tasks) {
  try {
    fs.mkdirSync(path.dirname(TASKS_FILE), { recursive: true });
    fs.writeFileSync(TASKS_FILE, JSON.stringify(tasks, null, 2), 'utf8');
  } catch (err) {
    console.error('Error saving tasks:', err);
  }
}

// GET /api/tasks - List all tasks
app.get('/api/tasks', (req, res) => {
  const tasks = loadTasks();
  res.json(tasks);
});

// POST /api/tasks - Create new task
app.post('/api/tasks', (req, res) => {
  const tasks = loadTasks();
  const newTask = {
    id: 't' + Date.now(),
    title: req.body.title || 'Untitled',
    desc: req.body.desc || '',
    priority: req.body.priority || 'medium',
    assignee: req.body.assignee || 'Jarvis',
    column: req.body.column || 'ideas',
    due: req.body.due || '',
    created: Date.now(),
    updated: Date.now()
  };
  tasks.push(newTask);
  saveTasks(tasks);
  res.json(newTask);
});

// PATCH /api/tasks/:id - Update task
app.patch('/api/tasks/:id', (req, res) => {
  const tasks = loadTasks();
  const task = tasks.find(t => t.id === req.params.id);
  if (!task) {
    return res.status(404).json({ error: 'Task not found' });
  }
  
  if (req.body.title !== undefined) task.title = req.body.title;
  if (req.body.desc !== undefined) task.desc = req.body.desc;
  if (req.body.priority !== undefined) task.priority = req.body.priority;
  if (req.body.assignee !== undefined) task.assignee = req.body.assignee;
  if (req.body.column !== undefined) task.column = req.body.column;
  if (req.body.due !== undefined) task.due = req.body.due;
  task.updated = Date.now();
  
  saveTasks(tasks);
  res.json(task);
});

// DELETE /api/tasks/:id - Delete task
app.delete('/api/tasks/:id', (req, res) => {
  let tasks = loadTasks();
  const index = tasks.findIndex(t => t.id === req.params.id);
  if (index === -1) {
    return res.status(404).json({ error: 'Task not found' });
  }
  
  tasks.splice(index, 1);
  saveTasks(tasks);
  res.json({ success: true });
});

